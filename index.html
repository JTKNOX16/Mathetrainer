<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Johanns Personal Mathetrainer</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#0b1020; --card:#101827; --muted:#94a3b8; --accent:#0ea5e9;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --text:#e5e7eb; --ring:#38bdf8;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .title{display:flex;gap:10px;align-items:center;font-weight:800;font-size:clamp(18px,3.2vw,26px)}
    .pill{background:#0b1222;border:1px solid #33415588;border-radius:999px;padding:6px 10px;font-size:12px;display:flex;gap:8px;align-items:center}
    .tag{font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid #334155aa;color:#cbd5e1}
    .hud{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;margin-bottom:12px}
    .tile{background:#0b1222;border:1px solid #33415566;border-radius:12px;padding:10px;text-align:center}
    .k{font-size:12px;color:var(--muted)} .v{font-weight:800;font-size:20px}
    .card{background:linear-gradient(180deg,#0f172a,#0b1222);border:1px solid #33415555;border-radius:16px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#0b1222;border:1px solid #33415588;border-radius:12px;color:var(--text);padding:10px 12px;cursor:pointer}
    .btn:hover{border-color:#22d3eeaa;box-shadow:0 0 0 2px #22d3ee22 inset}
    .btn.primary{background:linear-gradient(135deg,#0ea5e9,#22d3ee);color:#041119;font-weight:800}
    .btn.ok{background:linear-gradient(135deg,#10b981,#34d399);color:#03160f;font-weight:800}
    .btn.warn{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#1a1203;font-weight:800}
    .select,.input{background:#0b1222;border:1px solid #33415588;color:var(--text);border-radius:10px;padding:10px 12px}
    .q{font-size:clamp(22px,4.6vw,36px);font-weight:800;text-align:center;margin:8px 0 10px}
    .help{font-size:12px;color:var(--muted);text-align:center}
    .footer{margin-top:16px;display:flex;justify-content:space-between;color:var(--muted);font-size:12px}
    .switch{display:inline-flex;gap:8px;align-items:center}
    .switch input{appearance:none;width:42px;height:24px;border-radius:999px;background:#1f2937;position:relative;border:1px solid #334155;cursor:pointer}
    .switch input:checked{background:#22d3ee55;border-color:#22d3eeaa}
    .switch input::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#e5e7eb;transition:all .2s}
    .switch input:checked::after{left:22px;background:#041119}
    .coach{display:flex;gap:12px;align-items:center}
    .coach-ava{width:56px;height:56px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#22d3ee,#0ea5e9);border:2px solid #22d3eeaa;display:grid;place-items:center;box-shadow:0 6px 18px #0891b233}
    .banner{flex:1;background:linear-gradient(135deg,#0ea5e922,#22d3ee11);border:1px dashed #22d3ee66;border-radius:14px;padding:10px 12px}
    dialog{border:none;border-radius:16px;max-width:900px;width:92%;background:#0b1222;color:#fff;padding:0}
    dialog .dlg-head{padding:14px 16px;border-bottom:1px solid #33415566;font-weight:800}
    dialog .dlg-body{padding:16px}
    dialog .dlg-foot{padding:12px 16px;border-top:1px solid #33415566;display:flex;justify-content:flex-end;gap:8px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #33415555;text-align:left}
    th{color:#cbd5e1}
    .spark{height:40px;width:100%;display:block}
  </style>
</head>
<body>
  <div class="container">
    <!-- Topbar -->
    <div class="topbar">
      <div class="title">
        <span style="display:grid;place-items:center;width:30px;height:30px;border-radius:8px;background:radial-gradient(circle at 30% 30%,#22d3ee,#0ea5e9);border:1px solid #22d3ee77;box-shadow:0 4px 12px #0891b233">‚ûó</span>
        <span>Johanns Personal Mathetrainer</span>
        <span class="pill">
          <span id="rankName">Recruit</span>
          <span class="tag" id="rankBadge">Rang: Recruit</span>
        </span>
      </div>
      <div class="row">
        <label class="switch" title="Sprachausgabe an/aus">
          <input id="ttsToggle" type="checkbox" />
          <span>Sprachausgabe</span>
        </label>
        <label class="switch" title="Online-Teilnahme an der Bestenliste (Opt-in)">
          <input id="shareToggle" type="checkbox" />
          <span>Online teilen</span>
        </label>
        <button id="btnStats" class="btn">üìä Statistik</button>
        <button id="btnLeaderboard" class="btn">üåê Bestenliste</button>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="tile"><div class="k">Profil</div><div class="v" id="hudProfile">‚Äì</div></div>
      <div class="tile"><div class="k">XP</div><div class="v" id="hudXP">0</div></div>
      <div class="tile"><div class="k">Streak</div><div class="v" id="hudStreak">0</div></div>
      <div class="tile"><div class="k">Genauigkeit</div><div class="v" id="hudAcc">‚Äì</div></div>
      <div class="tile"><div class="k">Prestige</div><div class="v" id="hudPrestige">0</div></div>
      <div class="tile"><div class="k">Gruppe</div><div class="v" id="hudGroup">‚Äì</div></div>
    </div>

    <!-- Coach Banner + Profilverwaltung -->
    <div class="card" style="margin-bottom:12px">
      <div class="coach">
        <div class="coach-ava" aria-hidden="true">
          <svg width="34" height="34" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" fill="#022c3a"/>
            <circle cx="9" cy="10" r="1.4" fill="#22d3ee"/>
            <circle cx="15" cy="10" r="1.4" fill="#22d3ee"/>
            <path d="M8 15c1.5 1 3 1.5 4 1.5s2.5-.5 4-1.5" stroke="#22d3ee" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="banner">
          <div class="h" id="coachHeadline" style="font-weight:800">Let‚Äôs go! 10 saubere Aufgaben = Bonus</div>
          <div class="p" id="coachText" style="opacity:.9">Lies die Aufgabe, rechne im Kopf, antworte ‚Äì dann klicken.</div>
        </div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="row">
          <select id="profileSelect" class="select"></select>
          <input id="profileName" class="input" placeholder="Neues Profil (Name)" />
          <button id="btnAddProfile" class="btn">+ Profil</button>
          <button id="btnDelProfile" class="btn warn">Profil l√∂schen</button>
        </div>
        <div class="row">
          <input id="groupInput" class="input" placeholder="Gruppen-ID (z. B. 3a-2025)" style="width:180px" />
          <button id="btnSetGroup" class="btn">Gruppe setzen</button>
          <span class="tag">Build <span id="buildTag">v2.5-cloud</span></span>
        </div>
      </div>
    </div>

    <!-- Aufgabenkarte -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="btnStart" class="btn primary">‚ñ∂ Block starten</button>
          <button id="btnSkip" class="btn">‚è≠Ô∏è √úberspringen</button>
        </div>
        <div class="row">
          <span class="tag">Zeit <span id="hudTime">0.0s</span></span>
          <span class="tag">Block <span id="hudBlock">0/10</span></span>
        </div>
      </div>

      <div id="question" class="q">Bereit?</div>
      <div class="row" style="justify-content:center;margin-bottom:8px">
        <input id="answer" class="input" inputmode="numeric" placeholder="Antwort" style="min-width:140px;text-align:center;font-size:20px;font-weight:700" />
        <button id="btnCheck" class="btn ok">‚úÖ Pr√ºfen</button>
      </div>
      <div id="feedback" class="help">ENTER = Pr√ºfen ‚Ä¢ STRG+‚Üí = √úberspringen</div>
    </div>

    <div class="footer">
      <div>¬© 2025 ‚Äì A-Z Forst- und Gartenservice Meyer (Privatprojekt)</div>
      <div class="row"><span class="tag">PWA ready</span></div>
    </div>
  </div>

  <!-- Statistik Dialog -->
  <dialog id="dlgStats">
    <div class="dlg-head">Lernstatistik ‚Äì <span id="statsProfile">‚Äì</span></div>
    <div class="dlg-body">
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;min-width:230px">
          <div class="h" style="font-weight:800;margin-bottom:6px">Kennzahlen</div>
          <table>
            <tbody>
              <tr><td>Aufgaben gel√∂st</td><td id="stSolved">0</td></tr>
              <tr><td>Richtig (gesamt)</td><td id="stCorrect">0</td></tr>
              <tr><td>Genauigkeit</td><td id="stAcc">‚Äì</td></tr>
              <tr><td>√ò Zeit pro Aufgabe</td><td id="stAvg">‚Äì</td></tr>
              <tr><td>Beste Serie</td><td id="stBestStreak">0</td></tr>
              <tr><td>Aktueller Rang</td><td id="stRank">Recruit</td></tr>
              <tr><td>Prestige</td><td id="stPrestige">0</td></tr>
            </tbody>
          </table>
        </div>
        <div class="card" style="flex:1.4;min-width:280px">
          <div class="h" style="font-weight:800;margin-bottom:6px">Entwicklung (letzte 30 Antworten)</div>
          <canvas id="sparkline" class="spark" width="600" height="40"></canvas>
          <div class="help">Punkte: 1 = richtig, 0 = falsch ‚Ä¢ Linie: kumulative Trefferquote</div>
        </div>
      </div>
    </div>
    <div class="dlg-foot">
      <button id="btnResetStats" class="btn warn">Statistik zur√ºcksetzen</button>
      <button id="btnCloseStats" class="btn">Schlie√üen</button>
    </div>
  </dialog>

  <!-- Bestenliste Dialog -->
  <dialog id="dlgLeaderboard">
    <div class="dlg-head">üåê Bestenliste <span id="lbGroupTag" class="tag" style="margin-left:8px"></span></div>
    <div class="dlg-body">
      <div class="help" id="lbInfo" style="margin-bottom:8px">Anonyme Teilnahme. Nur Profilname, Gruppe und Leistungswerte werden gezeigt.</div>
      <table id="lbTable">
        <thead>
          <tr>
            <th>#</th><th>Profil</th><th>XP</th><th>Prestige</th><th>Accuracy</th><th>Best Streak</th><th>Zuletzt</th>
          </tr>
        </thead>
        <tbody id="lbBody">
          <tr><td colspan="7" class="help">Lade‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
    <div class="dlg-foot">
      <button id="btnCloseLb" class="btn">Schlie√üen</button>
    </div>
  </dialog>

  <!-- Firebase-Bridge: kleines ES-Modul, das window.firebaseApi bereitstellt -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { firebaseConfig, DEFAULT_GROUP_ID } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Anonyme Auth aktivieren
    let currentUid = null;
    try {
      await signInAnonymously(auth);
    } catch (e) {
      console.warn("Anonymous sign-in failed (may already be signed in).", e);
    }
    onAuthStateChanged(auth, (user) => {
      currentUid = user ? user.uid : null;
      console.info("Auth state:", currentUid ? "signed-in" : "signed-out");
    });

    async function pushScore(payload){
      // payload: { profileName, groupId, xp, prestige, bestStreak, accuracy, attempts, correct }
      if(!currentUid) throw new Error("Not authenticated");
      const doc = {
        ...payload,
        uid: currentUid,
        ts: serverTimestamp()
      };
      await addDoc(collection(db, "leaderboard"), doc);
      return true;
    }

    async function fetchLeaderboard(groupId, max=20){
      const q = query(
        collection(db, "leaderboard"),
        where("groupId", "==", groupId),
        orderBy("xp", "desc"),
        orderBy("ts", "desc"),
        limit(max)
      );
      const snap = await getDocs(q);
      return snap.docs.map((d)=>({ id:d.id, ...d.data() }));
    }

    // Stellt eine schlanke API bereit, auf die das Hauptskript zugreifen kann
    window.firebaseApi = {
      db,
      get groupId(){ return (localStorage.getItem('mt_group') || DEFAULT_GROUP_ID); },
      set groupId(val){ localStorage.setItem('mt_group', val); },
      pushScore,
      fetchLeaderboard,
      defaultGroup: DEFAULT_GROUP_ID
    };
  </script>

  <!-- Hauptskript (kein Modul) -->
  <script>
    // ===== Schutz: Stub, falls irgendwas zu fr√ºh auf updateHUD zugreift
    window.updateHUD = function(){};

    // ===== UI-Refs
    const ui = {
      rankName: document.getElementById('rankName'),
      rankBadge: document.getElementById('rankBadge'),
      hudProfile: document.getElementById('hudProfile'),
      hudXP: document.getElementById('hudXP'),
      hudStreak: document.getElementById('hudStreak'),
      hudAcc: document.getElementById('hudAcc'),
      hudTime: document.getElementById('hudTime'),
      hudBlock: document.getElementById('hudBlock'),
      hudPrestige: document.getElementById('hudPrestige'),
      hudGroup: document.getElementById('hudGroup'),
      coachHeadline: document.getElementById('coachHeadline'),
      coachText: document.getElementById('coachText'),
      profileSelect: document.getElementById('profileSelect'),
      profileName: document.getElementById('profileName'),
      btnAddProfile: document.getElementById('btnAddProfile'),
      btnDelProfile: document.getElementById('btnDelProfile'),
      btnStart: document.getElementById('btnStart'),
      btnSkip: document.getElementById('btnSkip'),
      btnCheck: document.getElementById('btnCheck'),
      btnStats: document.getElementById('btnStats'),
      btnLeaderboard: document.getElementById('btnLeaderboard'),
      question: document.getElementById('question'),
      answer: document.getElementById('answer'),
      feedback: document.getElementById('feedback'),
      ttsToggle: document.getElementById('ttsToggle'),
      shareToggle: document.getElementById('shareToggle'),
      groupInput: document.getElementById('groupInput'),
      btnSetGroup: document.getElementById('btnSetGroup'),
      dlgStats: document.getElementById('dlgStats'),
      dlgLeaderboard: document.getElementById('dlgLeaderboard'),
      lbGroupTag: document.getElementById('lbGroupTag'),
      lbBody: document.getElementById('lbBody'),
      st: {
        profile: document.getElementById('statsProfile'),
        solved: document.getElementById('stSolved'),
        correct: document.getElementById('stCorrect'),
        acc: document.getElementById('stAcc'),
        avg: document.getElementById('stAvg'),
        best: document.getElementById('stBestStreak'),
        rank: document.getElementById('stRank'),
        prestige: document.getElementById('stPrestige'),
        spark: document.getElementById('sparkline'),
      }
    };

    // ===== Persistenz (Profile + Settings)
    const persist = {
      loadAll(){ try{ return JSON.parse(localStorage.getItem('mt_profiles')||'{}'); }catch{return {}} },
      saveAll(obj){ localStorage.setItem('mt_profiles', JSON.stringify(obj)); },
      active(){ return localStorage.getItem('mt_active')||''; },
      setActive(id){ localStorage.setItem('mt_active', id); },
      build(){ return localStorage.getItem('mt_build')||'v0'; },
      setBuild(tag){ localStorage.setItem('mt_build', tag); },
      share(){ return localStorage.getItem('mt_share') === '1'; },
      setShare(v){ localStorage.setItem('mt_share', v?'1':'0'); }
    };

    // ===== State
    const state = {
      profileId: '',
      xp: 0, streak: 0, bestStreak: 0, correct: 0, attempts: 0, prestige: 0,
      history: [], // [{ok:boolean, t:number}]
      block: { total:10, index:0, started:false, t0:0 },
      current: { a:0, b:0, op:'+', res:0 },
      tts: false,
    };

    // ===== Utils
    function now(){ return performance.now(); }
    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function speak(text){
      if(!state.tts) return;
      try{
        const clean=(text||'').replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu,'');
        const u=new SpeechSynthesisUtterance(clean);
        u.lang='de-DE'; u.rate=1.0; u.pitch=1.0;
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch{}
    }

    // ===== Profile
    function defaultProfile(name){
      return { id: crypto.randomUUID(), name, xp:0, streak:0, bestStreak:0, correct:0, attempts:0, prestige:0, history:[], tts:false };
    }
    function getProfiles(){ return persist.loadAll(); }
    function saveProfiles(p){ persist.saveAll(p); }
    function getActiveProfile(){
      const all=getProfiles(); const id=persist.active();
      if(id && all[id]) return all[id];
      const arr=Object.values(all); return arr[0]||null;
    }
    function setActiveProfile(id){
      const all=getProfiles();
      if(all[id]){ persist.setActive(id); loadProfileIntoState(all[id]); }
    }
    function loadProfileIntoState(p){
      state.profileId=p.id; state.xp=p.xp||0; state.streak=p.streak||0; state.bestStreak=p.bestStreak||0;
      state.correct=p.correct||0; state.attempts=p.attempts||0; state.prestige=p.prestige||0;
      state.history=Array.isArray(p.history)? p.history.slice(-300) : [];
      state.tts=!!p.tts; ui.ttsToggle.checked=state.tts;
      updateHUD();
    }
    function saveStateToProfile(){
      if(!state.profileId) return;
      const all=getProfiles(); const p=all[state.profileId]; if(!p) return;
      Object.assign(p,{
        xp:state.xp, streak:state.streak, bestStreak:state.bestStreak,
        correct:state.correct, attempts:state.attempts, prestige:state.prestige,
        history:state.history, tts:state.tts
      });
      saveProfiles(all);
    }
    function refreshProfileSelect(){
      const all=getProfiles(); const ids=Object.keys(all);
      ui.profileSelect.innerHTML='';
      ids.forEach(id=>{
        const opt=document.createElement('option'); opt.value=id; opt.textContent=all[id].name;
        ui.profileSelect.appendChild(opt);
      });
      if(state.profileId){ ui.profileSelect.value=state.profileId; }
      ui.hudProfile.textContent = all[state.profileId]?.name || '‚Äì';
    }

    // ===== Rang & Prestige
    function getRank(xp){
      const tiers=[
        {name:'Recruit', req:0},{name:'Apprentice', req:50},{name:'Adept', req:120},
        {name:'Expert', req:240},{name:'Master', req:420},{name:'Legend', req:680},
      ];
      let r=tiers[0]; for(const t of tiers){ if(xp>=t.req) r=t; else break; } return r;
    }
    function maybeOfferPrestige(){
      const r=getRank(state.xp);
      if(r.name!=='Legend') return;
      setTimeout(()=>{
        if(confirm('Legend erreicht! Prestige aktivieren?\nDu bekommst ‚óà +1, XP werden zur√ºckgesetzt.')){
          state.prestige=(state.prestige||0)+1;
          state.xp=0; state.streak=0; saveStateToProfile(); updateHUD();
          ui.coachHeadline.textContent='Prestige aktiviert!';
          ui.coachText.textContent='XP auf 0. Bonus ‚óà erhalten. Weiter geht‚Äôs.';
          // nach Prestige optional gleich posten
          maybePushToCloud(true);
        }
      }, 120);
    }

    // ===== Aufgaben
    function nextTask(){
      const ops=['+','-','√ó','√∑']; let op=ops[rand(0,ops.length-1)];
      let a=rand(2,12), b=rand(2,12), res=0;
      if(op==='+'){ res=a+b; }
      else if(op==='-'){ if(b>a)[a,b]=[b,a]; res=a-b; }
      else if(op==='√ó'){ res=a*b; }
      else { res=rand(2,12); b=rand(2,12); a=res*b; op='√∑'; }
      state.current={a,b,op,res};
      ui.question.textContent=`${a} ${op} ${b} = ?`;
      ui.answer.value=''; ui.answer.focus(); state.block.t0=now(); speak(ui.question.textContent);
    }
    function startBlock(){
      state.block.index=0; state.block.started=true;
      ui.hudBlock.textContent=`0/${state.block.total}`; ui.hudTime.textContent='0.0s';
      ui.feedback.textContent='Viel Erfolg! 10 Aufgaben in Folge.'; nextTask(); updateHUD();
    }
    function checkAnswer(){
      if(!state.block.started) return;
      const val=Number(ui.answer.value.trim()); const took=(now()-state.block.t0)/1000;
      const ok=Number.isFinite(val) && (val===state.current.res);
      state.attempts++;
      if(ok){
        state.correct++; state.streak++; state.bestStreak=Math.max(state.bestStreak,state.streak);
        state.xp+=5; ui.feedback.textContent=`‚úÖ Richtig! +5 XP ‚Ä¢ ${took.toFixed(1)}s`; speak('Richtig!');
      }else{
        state.streak=0; ui.feedback.textContent=`‚ùå Leider nein. Richtig w√§re ${state.current.res}.`; speak('Leider falsch.');
      }
      state.history.push({ok,t:took}); state.history=state.history.slice(-300);
      state.block.index++; ui.hudBlock.textContent=`${Math.min(state.block.index,state.block.total)}/${state.block.total}`;
      ui.hudTime.textContent=`${took.toFixed(1)}s`;
      saveStateToProfile(); updateHUD();

      if(state.block.index>=state.block.total){
        const allOk=state.history.slice(-state.block.total).every(h=>h.ok);
        if(allOk){ state.xp+=20; ui.coachHeadline.textContent='Stark! Block fehlerfrei. +20 XP'; ui.coachText.textContent='Bei Legend kannst du prestigen.'; }
        else { ui.coachHeadline.textContent='Block geschafft!'; ui.coachText.textContent='Tipp: Konstanz schl√§gt Tempo.'; }
        state.block.started=false; saveStateToProfile(); updateHUD();
        // Nach Block: optional in die Cloud
        maybePushToCloud(false);
        // Legend-Check
        maybeOfferPrestige();
      }else{
        nextTask();
      }
    }
    function skipTask(){
      if(!state.block.started) return;
      state.streak=0; const took=(now()-state.block.t0)/1000;
      state.attempts++; state.history.push({ok:false,t:took}); state.block.index++;
      ui.feedback.textContent='‚è≠Ô∏è √úbersprungen.'; ui.hudBlock.textContent=`${state.block.index}/${state.block.total}`;
      saveStateToProfile(); updateHUD();
      if(state.block.index>=state.block.total){
        state.block.started=false; ui.coachHeadline.textContent='Block beendet (mit √úberspringen).'; ui.coachText.textContent='Kein Problem. N√§chster Block fokussiert.';
        maybePushToCloud(false);
      }else{ nextTask(); }
    }

    // ===== HUD (final, ersetzt Stub)
    window.updateHUD = function updateHUD(){
      const acc = state.attempts>0 ? Math.round((state.correct/state.attempts)*100) : null;
      ui.hudXP.textContent = state.xp;
      ui.hudStreak.textContent = state.streak;
      ui.hudAcc.textContent = acc==null ? '‚Äì' : acc+'%';
      ui.hudPrestige.textContent = state.prestige||0;
      // Rang/Badge
      const r=getRank(state.xp); const prest=state.prestige||0;
      let label=r.name;
      if(r.name==='Legend' && prest>0) label=`Legend ‚óà${prest}`;
      else if(r.name!=='Legend' && prest>0) label=`${r.name} ‚ü≤${prest+1}`;
      ui.rankName.textContent=label; ui.rankBadge.textContent='Rang: '+label;
      // Coach dynamisch
      if(state.streak>=5){ ui.coachHeadline.textContent='üî• Lauf! Serie ‚â• 5'; ui.coachText.textContent='Tempo halten, aber sauber bleiben.'; }
      else if(acc!==null && acc>=90){ ui.coachHeadline.textContent='Pr√§zise! Genauigkeit ‚â• 90%'; ui.coachText.textContent='Jetzt schrittweise schneller werden ‚Äì Ziel √ò < 5s.'; }
      // Gruppe anzeigen
      const gid = (window.firebaseApi?.groupId) || '‚Äì';
      ui.hudGroup.textContent = gid;
    };

    // ===== Statistik
    function openStats(){
      const p=getActiveProfile(); if(!p){ alert('Kein Profil. Bitte anlegen.'); return; }
      ui.st.profile.textContent=p.name;
      const solved=p.attempts||0, correct=p.correct||0, acc=solved?Math.round(100*correct/solved):0;
      const avg=(p.history&&p.history.length)? (p.history.reduce((s,h)=>s+h.t,0)/p.history.length):0;
      ui.st.solved.textContent=solved; ui.st.correct.textContent=correct;
      ui.st.acc.textContent=solved? acc+'%':'‚Äì'; ui.st.avg.textContent=solved? avg.toFixed(2)+'s':'‚Äì';
      ui.st.best.textContent=p.bestStreak||0; ui.st.rank.textContent=getRank(p.xp||0).name; ui.st.prestige.textContent=p.prestige||0;
      drawSpark(p.history||[]); ui.dlgStats.showModal();
    }
    function closeStats(){ ui.dlgStats.close(); }
    function resetStats(){
      if(!state.profileId) return;
      if(!confirm('Statistik wirklich zur√ºcksetzen?')) return;
      state.xp=0; state.streak=0; state.bestStreak=0; state.correct=0; state.attempts=0; state.history=[];
      saveStateToProfile(); updateHUD(); openStats();
    }
    function drawSpark(hist){
      const c=ui.st.spark, ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
      const n=Math.min(30,hist.length); const slice=hist.slice(-n); const w=c.width,h=c.height;
      // Punkte
      for(let i=0;i<slice.length;i++){
        const x=(i/(n-1||1))*w; const y=h-(slice[i].ok? h*0.8:h*0.2);
        ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fillStyle='#22d3ee'; ctx.fill();
      }
      // kumulative Quote
      let cum=0; ctx.beginPath();
      for(let i=0;i<slice.length;i++){
        cum+=slice[i].ok?1:0; const rate=cum/(i+1);
        const x=(i/(n-1||1))*w; const y=h - rate*h*0.9;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.lineWidth=2; ctx.strokeStyle='#38bdf8'; ctx.stroke();
    }

    // ===== Cloud: Push & Fetch
    async function maybePushToCloud(force){
      try{
        const online = !!window.firebaseApi;
        const share = persist.share();
        if(!online || (!share && !force)) return;
        const all=getProfiles(); const p=all[state.profileId];
        if(!p) return;
        const acc = p.attempts>0 ? Math.round(100*p.correct/p.attempts) : 0;
        const payload = {
          profileName: p.name,
          groupId: window.firebaseApi.groupId,
          xp: p.xp||0,
          prestige: p.prestige||0,
          bestStreak: p.bestStreak||0,
          accuracy: acc,
          attempts: p.attempts||0,
          correct: p.correct||0
        };
        await window.firebaseApi.pushScore(payload);
        console.info('Score in Cloud gespeichert', payload);
      }catch(e){
        console.warn('Cloud-Speichern fehlgeschlagen:', e.message||e);
      }
    }

    async function openLeaderboard(){
      const online = !!window.firebaseApi;
      if(!online){ alert('Cloud nicht initialisiert. Pr√ºfe firebase-config.js'); return; }
      const gid = window.firebaseApi.groupId;
      ui.lbGroupTag.textContent = gid;
      ui.lbBody.innerHTML = `<tr><td colspan="7" class="help">Lade‚Ä¶</td></tr>`;
      try{
        const rows = await window.firebaseApi.fetchLeaderboard(gid, 25);
        if(rows.length===0){
          ui.lbBody.innerHTML = `<tr><td colspan="7" class="help">Noch keine Eintr√§ge.</td></tr>`;
        }else{
          ui.lbBody.innerHTML = rows.map((r,idx)=>{
            const ts = r.ts?.toDate ? r.ts.toDate() : null;
            const dateStr = ts ? new Date(ts).toLocaleString() : '‚Äì';
            return `<tr>
              <td>${idx+1}</td>
              <td>${escapeHtml(r.profileName||'‚Äì')}</td>
              <td>${r.xp??0}</td>
              <td>${r.prestige??0}</td>
              <td>${(r.accuracy??0)}%</td>
              <td>${r.bestStreak??0}</td>
              <td>${dateStr}</td>
            </tr>`;
          }).join('');
        }
      }catch(e){
        ui.lbBody.innerHTML = `<tr><td colspan="7" class="help">Fehler beim Laden: ${escapeHtml(e.message||String(e))}</td></tr>`;
      }
      ui.dlgLeaderboard.showModal();
    }
    function closeLeaderboard(){ ui.dlgLeaderboard.close(); }
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ===== Init & Events
    function bootstrap(){
      const build='v2.5-cloud'; document.getElementById('buildTag').textContent=build; persist.setBuild(build);

      // Gruppe init
      const defaultGroup = (window.firebaseApi?.defaultGroup) || 'default';
      if(!localStorage.getItem('mt_group')) localStorage.setItem('mt_group', defaultGroup);
      ui.groupInput.value = localStorage.getItem('mt_group');
      ui.hudGroup.textContent = localStorage.getItem('mt_group');

      // Default-Profil, falls leer
      let all=getProfiles();
      if(Object.keys(all).length===0){ const p=defaultProfile('Johann'); all[p.id]=p; saveProfiles(all); persist.setActive(p.id); }
      const active=getActiveProfile(); if(active){ loadProfileIntoState(active); }
      refreshProfileSelect(); updateHUD();

      // Share Toggle
      ui.shareToggle.checked = persist.share();
      ui.shareToggle.onchange = ()=>{ persist.setShare(ui.shareToggle.checked); };

      // Events: Profile
      ui.btnAddProfile.onclick=()=>{
        const name=(ui.profileName.value||'').trim(); if(!name){ alert('Bitte Name eingeben.'); return; }
        const all=getProfiles(); const p=defaultProfile(name); all[p.id]=p; saveProfiles(all); setActiveProfile(p.id);
        ui.profileName.value=''; refreshProfileSelect(); updateHUD();
      };
      ui.btnDelProfile.onclick=()=>{
        if(!state.profileId) return; const all=getProfiles();
        if(!confirm(`Profil "${all[state.profileId].name}" wirklich l√∂schen?`)) return;
        delete all[state.profileId]; saveProfiles(all);
        const first=Object.keys(all)[0]; if(first){ setActiveProfile(first); }
        else { const p=defaultProfile('Profil 1'); all[p.id]=p; saveProfiles(all); setActiveProfile(p.id); }
        refreshProfileSelect(); updateHUD();
      };
      ui.profileSelect.onchange=(e)=> setActiveProfile(e.target.value);

      // Gruppe setzen
      ui.btnSetGroup.onclick = ()=>{
        const val = (ui.groupInput.value||'').trim();
        if(!val){ alert('Bitte Gruppen-ID eingeben.'); return; }
        if(window.firebaseApi){ window.firebaseApi.groupId = val; }
        ui.hudGroup.textContent = val;
      };

      // Gameplay
      ui.btnStart.onclick=startBlock; ui.btnSkip.onclick=skipTask; ui.btnCheck.onclick=checkAnswer;
      ui.answer.addEventListener('keydown',(e)=>{ if(e.key==='Enter') checkAnswer(); });
      document.addEventListener('keydown',(e)=>{ if(e.ctrlKey&&e.key==='ArrowRight'){ e.preventDefault(); skipTask(); } });

      // Einstellungen
      ui.ttsToggle.onchange=()=>{ state.tts=ui.ttsToggle.checked; saveStateToProfile(); if(state.tts) speak('Sprachausgabe aktiviert.'); };

      // Dialoge
      ui.btnStats.onclick=openStats; document.getElementById('btnCloseStats').onclick=closeStats; document.getElementById('btnResetStats').onclick=resetStats;
      ui.btnLeaderboard.onclick=openLeaderboard; document.getElementById('btnCloseLb').onclick=closeLeaderboard;

      ui.question.textContent='Dr√ºcke ‚ÄûBlock starten‚Äú, um loszulegen.';
      ui.feedback.textContent='Ziel: 10 Aufgaben. Sauber rechnen, dann Tempo erh√∂hen.';
    }
    window.addEventListener('load', bootstrap);

    // ===== PWA / Service Worker
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('./service-worker.js').catch(console.warn);
      });
    }
  </script>

  <noscript>
    <div style="padding:12px;margin:12px;border:2px solid #ef4444;border-radius:10px;background:#1f2937;color:#fff">
      Diese App ben√∂tigt JavaScript.
    </div>
  </noscript>
</body>
</html>

