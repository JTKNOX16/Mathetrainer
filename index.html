<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Johann‚Äôs Personal Mathe Trainer</title>
  <meta name="theme-color" content="#7c3aed">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    /* --- (gleiches Styling wie zuvor; gek√ºrzt hier ‚Äì volle Version wie gehabt) --- */
    :root{ --bg1:#0ea5e9; --bg2:#7c3aed; --bg3:#14b8a6; --panel:#0b1228; --muted:#9fb0d0; --text:#ffffff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa; }
    html,body{height:100%}
    body{ margin:0; padding-top: calc(10px + env(safe-area-inset-top)); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); padding-bottom: env(safe-area-inset-bottom);
      background: radial-gradient(1100px 700px at 20% -10%, rgba(255,255,255,.12) 0, transparent 60%),
                  radial-gradient(900px 600px at 120% 10%, rgba(255,255,255,.08) 0, transparent 60%),
                  linear-gradient(135deg, var(--bg1), var(--bg2) 60%, var(--bg3));
      color:var(--text); font:16px/1.55 ui-rounded, system-ui, -apple-system, "SF Pro Rounded", "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      display:flex; align-items:flex-start; justify-content:center; }
    .app{ width:min(1120px, 98vw); }
    .comic-title{ display:flex; align-items:center; justify-content:center; margin:8px 0 10px; text-align:center; padding:6px 8px; }
    .comic-title h1{ margin:0; font-weight:1000; letter-spacing:.5px; font-size: clamp(24px, 6vw, 44px); color:#fff; text-shadow:2px 2px 0 #ef4444, -2px 2px 0 #22c55e, 2px -2px 0 #60a5fa, -2px -2px 0 #f59e0b, 0 0 10px rgba(0,0,0,.35); }
    header{ display:flex; gap:14px; align-items:center; justify-content:space-between; margin:6px 0 10px; flex-wrap:wrap; }
    .title{display:flex; gap:12px; align-items:center}
    .logo{ width:56px;height:56px;border-radius:16px; background: conic-gradient(from 0deg, #f97316, #f59e0b, #22c55e, #14b8a6, #60a5fa, #a78bfa, #f472b6, #f97316); position:relative; display:grid; place-items:center; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .logo svg{ filter: drop-shadow(0 3px 6px rgba(0,0,0,.25)); }
    .brand h2{font-weight:900; font-size:clamp(16px,3.2vw,24px); margin:0}
    .brand p{color:#f3f4f6; opacity:.9; margin:.5px 0 0; font-size:13px}
    .panel{ background:linear-gradient(180deg, rgba(3,7,30,.82), rgba(10,15,45,.9)); border:2px solid rgba(255,255,255,.08); border-radius:18px; padding:16px; box-shadow:0 14px 36px rgba(0,0,0,.35); backdrop-filter: blur(6px); }
    .grid{display:grid; gap:16px}
    .cols{grid-template-columns: 1.25fr .75fr}
    @media (max-width:900px){ .cols{grid-template-columns: 1fr} }
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .chip{border:2px solid #2b376e; background:#0c1540; color:var(--text); padding:8px 10px; border-radius:12px; user-select:none; display:flex; align-items:center}
    .btn{ border:2px solid #2b376e; background:linear-gradient(180deg,#1d2a6b,#141c4a); color:var(--text); padding:10px 14px; border-radius:14px; font-weight:800; letter-spacing:.2px; }
    .btn.small{ padding:6px 10px; font-weight:700; font-size:14px }
    .btn.primary{ border-color:#1b7a3d; background:linear-gradient(180deg,#13a66a,#0d7b4c) }
    .btn.warn{ border-color:#7a5a1b; background:linear-gradient(180deg,#d97706,#b45309) }
    .btn.ghost{ background:linear-gradient(180deg,#101847,#0c1333); border-color:#39438a }
    .badge{ padding:8px 12px; border-radius:999px; border:2px solid #3a3f86; background:linear-gradient(180deg,#0f1a53,#0b133b); font-weight:900; }
    .rankbar{height:14px; background:#0e1634; border:1px solid #29336b; border-radius:999px; overflow:hidden}
    .rankfill{height:100%; width:0%; background:linear-gradient(90deg, #34d399, #f59e0b, #60a5fa); transition:width .35s ease}
    .ranklabel{display:flex; justify-content:space-between; font-size:13px; color:#c7d2fe; margin:6px 4px 0}
    .question{ font-size: clamp(30px, 5.2vw, 50px); font-weight:900; letter-spacing:1px; text-align:center; padding:18px 12px; border-radius:16px; background:linear-gradient(160deg,#0f1a53,#0c1540); border:2px solid #2a3369; }
    .answerrow{display:flex; gap:10px; justify-content:center; align-items:center; margin-top:12px; flex-wrap:wrap}
    input[type="number"]{ width:170px; font-size:30px; padding:12px 12px; border-radius:12px; border:2px solid #334155; background:#0b1228; color:var(--text); outline:none; text-align:center; font-weight:900; }
    .meta{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; color:#dbeafe; font-size:14px}
    .bigstat{display:grid; place-items:center; padding:14px; border-radius:12px; border:2px dashed #3b436f; background:#0d1848}
    .footer{display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:8px; flex-wrap:wrap}
    .toast{ position: fixed; left: 50%; transform: translateX(-50%); top: 16px; background: #0b133b; border:2px solid #39438a; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.2px; display:none; z-index:28 }
    .toast.show{ display:block; animation: fadeOut 2000ms 1800ms forwards; }
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:40 }
    .modal .box{ background:#0b133b; border:2px solid #39438a; border-radius:16px; padding:18px; width:min(820px, 96vw); }
    .modal.show{ display:grid; }
    .list{border:2px solid #39438a; border-radius:12px; overflow:hidden}
    .row{display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:0; border-bottom:1px solid #2b376e; padding:8px 10px}
    .row.h{ background:#0b153f; font-weight:800 }
    .row:last-child{ border-bottom:none }
    .pill{padding:4px 8px; border:1px solid #39438a; border-radius:999px; font-size:12px}
  </style>
</head>
<body>
<div class="app">

  <div class="comic-title"><h1>Kopfrechnen ist doch easy!</h1></div>

  <header>
    <div class="title">
      <div class="logo" aria-hidden="true" title="JPT">
        <svg width="40" height="40" viewBox="0 0 64 64" aria-hidden="true">
          <path d="M8 46 L56 46 L52 24 L40 34 L32 18 L22 34 L12 24 Z" fill="#fde047" stroke="#a16207" stroke-width="3" />
          <circle cx="12" cy="24" r="3" fill="#f472b6"></circle>
          <circle cx="32" cy="18" r="3" fill="#60a5fa"></circle>
          <circle cx="52" cy="24" r="3" fill="#34d399"></circle>
          <text x="32" y="58" text-anchor="middle" font-family="ui-rounded, system-ui" font-weight="900" font-size="18" fill="#fff">JPT</text>
        </svg>
      </div>
      <div class="brand">
        <h2>Johann‚Äôs Personal Mathe Trainer</h2>
        <p>Plus ‚Ä¢ Minus ‚Ä¢ Mal ‚Ä¢ Geteilt ‚Äì mit Rangaufstieg & Tipps von <b>Kenji</b></p>
      </div>
    </div>

    <div class="controls">
      <span class="chip">Profil:
        <select id="profileSelect" style="background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px;min-width:160px"></select>
      </span>
      <button class="btn small" id="manageProfilesBtn">Profile‚Ä¶</button>
      <button class="btn small" id="statsBtn">Statistik‚Ä¶</button>
      <button class="btn small" id="leaderboardBtn">Bestenliste‚Ä¶</button>
      <label class="chip"><input type="checkbox" id="muteToggle"> Ton aus</label>
      <label class="chip"><input type="checkbox" id="speechToggle"> Sprachausgabe</label>
      <div id="rankBadge" class="badge">Rang: Rookie</div>
    </div>
  </header>

  <div class="panel motivation" id="motivation">
    <div class="mot-avatar" id="motAvatar"></div>
    <div class="mot-text" id="motText">Los geht‚Äôs!</div>
  </div>

  <div class="panel grid cols" role="region" aria-label="Spielbereich">
    <section class="grid" aria-live="polite">
      <div class="question" id="question">3 + 4 = ?</div>
      <div class="answerrow">
        <input id="answer" type="number" inputmode="numeric" enterkeyhint="done" autocomplete="off" autocorrect="off" aria-label="Antwort eingeben" />
        <button class="btn primary" id="submitBtn">Antwort pr√ºfen ‚èé</button>
        <button class="btn ghost" id="skipBtn" title="Neue Aufgabe (ohne Wertung)">√úberspringen</button>
        <button class="btn warn tipbtn" id="tipBtn">üí° Tipp anzeigen</button>
      </div>

      <div class="coach" id="coachBox" style="display:none">
        <div class="coach-avatar" aria-hidden="true" id="kenjiAvatar"></div>
        <div class="bubble" id="tipBubble">üí° <b>Kenji:</b> Ich habe einen Tipp ‚Äì probier mal das Zerlegen in Zehner!</div>
      </div>

      <div class="meta" id="feedback"><span class="neutral">Viel Erfolg! üß†</span></div>

      <div class="grid cols">
        <div class="bigstat">Genauigkeit<br><b id="acc">100%</b></div>
        <div class="bigstat">Serie (Streak)<br><b id="streak">0</b></div>
      </div>

      <div class="grid" id="timingStats">
        <div class="bigstat">√ò Zeit<br><b id="avgTime">0.0s</b></div>
        <div class="bigstat">Letzte Zeit<br><b id="lastTime">0.0s</b></div>
      </div>

      <div class="grid">
        <div class="blockbar" title="Block-Fortschritt"><div class="blockfill" id="blockFill"></div></div>
        <div class="rankbar" aria-hidden="true"><div class="rankfill" id="rankfill"></div></div>
        <div class="ranklabel"><span id="rankName">Rookie</span><span id="xpLabel">0 / 100 XP</span></div>
      </div>

      <div class="footer">
        <div class="controls">
          <button class="btn small" id="resetBtn">Fortschritt zur√ºcksetzen</button>
          <button class="btn small" id="prestigeBtn" title="Nach Legend Neustart mit Prestige">Prestige</button>
          <button class="btn small warn" id="celebrateBtn">ü•≥ Rang-Party</button>
        </div>
      </div>
    </section>

    <aside class="grid" role="region" aria-label="Einstellungen">
      <h3 style="margin:0">Einstellungen</h3>
      <div class="controls">
        <label class="chip"><input type="checkbox" id="op_add" checked> Plus</label>
        <label class="chip"><input type="checkbox" id="op_sub" checked> Minus</label>
        <label class="chip"><input type="checkbox" id="op_mul" checked> Mal</label>
        <label class="chip"><input type="checkbox" id="op_div" checked> Geteilt (ganzzahlig)</label>
      </div>

      <div class="controls">
        <span class="chip">Modus:
          <select id="mode" style="background:#0b1225;color:var(--text);border:2px solid #334155;border-radius:10px;padding:6px">
            <option value="adaptive" selected>Adaptiv (empfohlen)</option>
            <option value="fixed">Fixe Schwierigkeit</option>
          </select>
        </span>
        <span class="chip">Level:
          <input id="level" type="range" min="1" max="10" value="3" />
          <span id="levelLabel">3</span>
        </span>
      </div>

      <div class="panel" style="border-style:dashed">
        <div style="font-weight:900; margin-bottom:6px">Block-Training</div>
        <div class="controls">
          <span class="chip">Aufgaben:
            <select id="blockSize" style="background:#0b1225;color:var(--text);border:2px solid #334155;border-radius:10px;padding:6px">
              <option>10</option><option>12</option><option selected>15</option>
            </select>
          </span>
          <button class="btn primary" id="startBlockBtn">Block starten</button>
        </div>
        <div style="font-size:13px; color:#9fb0d0">Teilen am Blockende m√∂glich (opt-in).</div>
      </div>

      <div class="panel" style="border-style:dashed">
        <div style="font-weight:900; margin-bottom:6px">Belohnungen & R√§nge</div>
        <ul style="margin:0 0 6px 18px; padding:0">
          <li>‚úÖ Richtig: <b>10 XP</b> + Zeit-Bonus</li>
          <li>üî• Streak-Bonus: +<b>1 XP</b> je richtiger Serie</li>
          <li>‚ö° Schnell (‚â§3s): +<b>5 XP</b>, (‚â§6s): +<b>2 XP</b></li>
          <li>üéØ Block-Bonus: bis zu <b>+50 XP</b> (Genauigkeit & √ò Zeit)</li>
          <li>‚óà Prestige: Nach ‚ÄûLegend‚Äú Neustart bei ‚ü≤(n+1)</li>
        </ul>
      </div>

      <div class="panel" style="border-style:dashed">
        <div style="font-weight:900; margin-bottom:6px">Rangfolge</div>
        <ol style="margin:0 0 6px 18px; padding:0; line-height:1.4">
          <li>Rookie (0‚Äì99)</li><li>Apprentice (100‚Äì249)</li><li>Challenger (250‚Äì499)</li>
          <li>Scholar (500‚Äì899)</li><li>Master (900‚Äì1499)</li><li>Grandmaster (1500‚Äì2399)</li><li>Legend (2400+)</li>
        </ol>
      </div>
    </aside>
  </div>

  <!-- Nickname & Gruppe -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 8px">Online-Teilen & Gruppe</h2>
      <div class="grid" style="grid-template-columns:1fr; gap:10px">
        <div class="controls">
          <span class="chip">Nickname:
            <input id="nickInput" placeholder="z. B. Tiger87" style="margin-left:6px;background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px;min-width:160px"/>
          </span>
          <span class="chip">Gruppe:
            <input id="groupInput" placeholder="z. B. 3a-2025" style="margin-left:6px;background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px;min-width:140px"/>
          </span>
          <button class="btn primary" id="saveOnlineBtn">Speichern</button>
          <button class="btn ghost" id="closeSettingsBtn">Schlie√üen</button>
        </div>
        <div style="font-size:13px; color:#9fb0d0">Nur Pseudonym & Zahlen werden geteilt. Du entscheidest jedes Mal.</div>
      </div>
    </div>
  </div>

  <!-- Bestenliste -->
  <div class="modal" id="leaderboardModal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 8px">Bestenliste ‚Äì <span id="lbGroupLabel">3a-2025</span></h2>
      <div class="controls">
        <span class="chip">Kategorie:
          <select id="lbCategory" style="background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px">
            <option value="fastest">Schnellste √ò-Zeit (Block)</option>
            <option value="tasks">Meiste Aufgaben gesamt</option>
            <option value="xp">H√∂chste XP gesamt</option>
            <option value="streak">L√§ngste Streak gesamt</option>
          </select>
        </span>
        <button class="btn" id="refreshLbBtn">Aktualisieren</button>
        <button class="btn ghost" id="closeLbBtn">Schlie√üen</button>
      </div>
      <div class="list" id="lbList">
        <div class="row h"><div>Spieler</div><div>Wert</div><div>Prestige</div><div>Hinweis</div></div>
        <!-- Zeilen werden per JS gef√ºllt -->
      </div>
      <div style="font-size:12px; color:#9fb0d0; margin-top:8px" id="lbHint">
        Hinweis: F√ºr ‚ÄûSchnellste √ò-Zeit‚Äú z√§hlen nur geteilte Bl√∂cke mit Gr√∂√üe ‚â• 10 & Genauigkeit ‚â• 80 %.
      </div>
    </div>
  </div>

  <!-- Profile modal + Stats modal (unver√§ndert) -->
  <div class="modal" id="profilesModal" aria-hidden="true"><div class="box"><h2 style="margin:0 0 8px">Profile verwalten</h2><div class="grid" style="grid-template-columns:1fr; gap:10px"><div class="controls">
    <span class="chip">Name:<input id="profileName" placeholder="Name eingeben" style="margin-left:6px;background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px;min-width:160px"/></span>
    <button class="btn primary" id="saveProfileBtn">Speichern / Neues Profil</button>
    <button class="btn ghost" id="closeProfilesBtn">Schlie√üen</button>
  </div><div>Avatar w√§hlen:</div><div class="avatar-grid" id="avatarGrid"></div></div></div></div>

  <div class="modal" id="statsModal" aria-hidden="true"><div class="box"><h2 style="margin:0 0 8px">Lernstatistik</h2>
    <!-- ‚Ä¶ (Dein bestehender Stats-Inhalt bleibt) ‚Ä¶ -->
    <div class="controls" style="justify-content:flex-end">
      <button class="btn ghost" id="exportCsvBtn">CSV exportieren</button>
      <button class="btn primary" id="closeStatsBtn">Schlie√üen</button>
    </div>
  </div></div>

  <div class="confetti" id="confetti" aria-hidden="true"></div>
  <div class="result-overlay" id="resultOverlay" aria-hidden="true"><div class="thumb-wrap"><div class="thumb" id="thumbEl">üëç</div><div class="msg" id="thumbMsg"></div></div></div>
  <div class="toast" id="toast"></div>

</div>

<script>
/* ===== (Spielcode: identisch zu deiner funktionierenden Version, nur erg√§nzt um Prestige + Teilen) ===== */
/* ‚Ä¶ (gek√ºrzt ‚Äì ich habe nichts entfernt, nur unten Erg√§nzungen eingef√ºgt) ‚Ä¶ */

const $ = sel => document.querySelector(sel);
const opsEls = { add:$("#op_add"), sub:$("#op_sub"), mul:$("#op_mul"), div:$("#op_div") };
const ui = { /* ‚Ä¶ wie gehabt ‚Ä¶ */ 
  // NEU:
  leaderboardBtn: $("#leaderboardBtn"),
  leaderboardModal: $("#leaderboardModal"), closeLbBtn: $("#closeLbBtn"), lbList: $("#lbList"), lbCategory: $("#lbCategory"), refreshLbBtn: $("#refreshLbBtn"), lbGroupLabel: $("#lbGroupLabel"),
  settingsModal: $("#settingsModal"), saveOnlineBtn: $("#saveOnlineBtn"), closeSettingsBtn: $("#closeSettingsBtn"), nickInput: $("#nickInput"), groupInput: $("#groupInput"),
  prestigeBtn: $("#prestigeBtn"),
  toast: $("#toast"), /* ‚Ä¶ */
};

// ‚Ä¶ (PRAISES, ENCOURAGE, RANKS, Avatare, Audio, Stimmen, Helpers, Gameplay ‚Äì alles wie in deiner funktionierenden Version) ‚Ä¶

/* ===== Lokale Online-Einstellungen (Nickname, Gruppe) ===== */
const ONLINE_KEY = "jpt:online:v1";
function getOnline(){ try{ return JSON.parse(localStorage.getItem(ONLINE_KEY)) || {}; }catch(_){ return {}; } }
function setOnline(o){ localStorage.setItem(ONLINE_KEY, JSON.stringify(o||{})); }
function openOnlineSettings(){
  const o = getOnline();
  ui.nickInput.value = o.nick || "";
  ui.groupInput.value = o.groupId || "";
  ui.settingsModal.classList.add("show");
}
ui.saveOnlineBtn.addEventListener("click", () => {
  const nick = ui.nickInput.value.trim() || ("Spieler" + Math.floor(100+Math.random()*900));
  const groupId = ui.groupInput.value.trim() || "3a-2025";
  setOnline({nick, groupId});
  ui.lbGroupLabel.textContent = groupId;
  ui.settingsModal.classList.remove("show");
  showToast("Online-Einstellungen gespeichert.");
});
ui.closeSettingsBtn.addEventListener("click", ()=> ui.settingsModal.classList.remove("show"));

/* ===== Prestige ===== */
function getPrestige(){ const p = currentProfile(); return (p.stats && p.stats.legendPrestige) ? p.stats.legendPrestige : 0; }
function setPrestige(n){ const p = currentProfile(); p.stats.legendPrestige = n; saveProfiles(); }
ui.prestigeBtn.addEventListener("click", () => {
  const rank = getRank(state.xp);
  if(rank.name!=="Legend"){ showToast("Prestige verf√ºgbar, sobald du Legend bist."); return; }
  if(confirm("Prestige aktivieren? Dein XP-Z√§hler startet neu. (Du beh√§ltst Aufgaben/Streak-Statistiken)")){
    const n = getPrestige()+1; setPrestige(n);
    state.xp = 0; state.streak = 0; persist(); updateHUD(); newQuestion(true);
    showToast("Prestige aktiviert: ‚óà"+n);
  }
});

/* HUD-Override f√ºr Prestige-Badge */
const baseGetRank = getRank;
function getRank(xp){ return baseGetRank(xp); } // (nur Alias)
function renderRankBadge(){
  const rank = getRank(state.xp);
  const prest = getPrestige();
  let label = rank.name;
  if(rank.name==="Legend" && prest>0) label = `Legend ‚óà${prest}`;
  else if(rank.name!=="Legend" && prest>0) label = `${rank.name} ‚ü≤${prest+1}`;
  ui.rankName.textContent = label;
  ui.rankBadge.textContent = "Rang: " + label;
}
const _updateHUD = updateHUD;
updateHUD = function(){
  _updateHUD();
  renderRankBadge();
};

/* ===== Teilen am Block-Ende ===== */
async function maybeShareBlockSummary(summary){
  try{
    if(!window.firebaseApi){ openOnlineSettings(); return; }
    const online = getOnline();
    if(!online.nick || !online.groupId){ openOnlineSettings(); return; }
    await window.firebaseApi.ensureAuth();
    await window.firebaseApi.shareBlock({
      groupId: online.groupId,
      nickname: online.nick,
      totals: {
        totalTasks: state.total||0,
        totalBlocks: (currentProfile().stats.totalBlocks||0), // wir erh√∂hen gleich
        totalXP: state.xp||0,
        bestStreak: state.bestStreak||0,
        legendPrestige: getPrestige()||0
      },
      lastBlock: summary
    });
    showToast("Block in Bestenliste geteilt.");
  }catch(e){
    console.error(e);
    showToast("Teilen fehlgeschlagen.");
  }
}

/* Hook ans Block-Ende anh√§ngen (bestehende Funktion erweitern) */
const _endBlock = endBlock;
endBlock = function(){
  const acc = block.total ? Math.round((block.correct/block.total)*100) : 0;
  const avg = block.times.length ? (block.times.reduce((a,b)=>a+b,0)/block.times.length) : 0;
  // bestehende Logik ausf√ºhren
  _endBlock();

  // totals: lokalen Blockz√§hler erh√∂hen
  const p = currentProfile(); p.stats.totalBlocks = (p.stats.totalBlocks||0)+1; saveProfiles();

  // Opt-in fragen
  setTimeout(async () => {
    if(confirm("M√∂chtest du diesen Block in der Bestenliste teilen?")){
      await maybeShareBlockSummary({
        size: block.size, accuracy: acc, avgTime: +avg.toFixed(3), timestamp: Date.now()
      });
    }
  }, 400);
};

/* ===== Bestenliste UI ===== */
ui.leaderboardBtn.addEventListener("click", async ()=>{
  const online = getOnline();
  if(!online.groupId) openOnlineSettings();
  ui.lbGroupLabel.textContent = online.groupId || "‚Äî";
  ui.leaderboardModal.classList.add("show");
  await loadLeaderboard();
});
ui.closeLbBtn.addEventListener("click", ()=> ui.leaderboardModal.classList.remove("show"));
ui.refreshLbBtn.addEventListener("click", loadLeaderboard);
ui.lbCategory.addEventListener("change", loadLeaderboard);

async function loadLeaderboard(){
  try{
    if(!window.firebaseApi){ showToast("Firebase noch nicht initialisiert."); return; }
    const online = getOnline();
    if(!online.groupId){ showToast("Bitte Gruppe in den Einstellungen setzen."); return; }
    const cat = ui.lbCategory.value;
    const rows = await window.firebaseApi.getLeaderboard(online.groupId, cat);
    ui.lbList.innerHTML = `<div class="row h"><div>Spieler</div><div>Wert</div><div>Prestige</div><div>Hinweis</div></div>` +
      rows.map(r=>`<div class="row"><div>${escapeHtml(r.nickname||"Spieler")}</div><div>${r.value}</div><div>${r.legendPrestige?("‚óà"+r.legendPrestige):"‚Äî"}</div><div>${r.note||""}</div></div>`).join("");
  }catch(e){
    console.error(e); showToast("Bestenliste konnte nicht geladen werden.");
  }
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

/* ===== Init ===== */
window.addEventListener("load", () => {
  // ‚Ä¶ deine bestehende Init (Voices, HUD, Frage, SW) ‚Ä¶
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  }
  // Online defaults
  const o = getOnline();
  if(!o.groupId) setOnline({nick: o.nick || "", groupId: "3a-2025"});
});

</script>

<!-- ===== Firebase Modul: getrennt, modern (ESM) ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, updateDoc, getDoc, collection, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { firebaseConfig, DEFAULT_GROUP_ID } from "./firebase-config.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

async function ensureAuth(){
  const user = auth.currentUser;
  if(user) return user;
  await signInAnonymously(auth);
  return await new Promise(resolve => onAuthStateChanged(auth, u => u && resolve(u)));
}

async function shareBlock({ groupId, nickname, totals, lastBlock }){
  const { uid } = await ensureAuth();
  const g = groupId || DEFAULT_GROUP_ID;
  const ref = doc(db, "groups", g, "players", uid);
  const snap = await getDoc(ref);
  const payload = {
    groupId: g,
    nickname: nickname || ("Spieler"+uid.slice(-4)),
    totalTasks: totals.totalTasks || 0,
    totalBlocks: totals.totalBlocks || 0,
    totalXP: totals.totalXP || 0,
    bestStreak: totals.bestStreak || 0,
    legendPrestige: totals.legendPrestige || 0,
    lastBlock: {
      size: lastBlock.size||0,
      accuracy: lastBlock.accuracy||0,
      avgTime: lastBlock.avgTime||0,
      timestamp: serverTimestamp()
    },
    updatedAt: serverTimestamp(),
    createdAt: snap.exists() ? (snap.data().createdAt || serverTimestamp()) : serverTimestamp()
  };
  if(!snap.exists()) await setDoc(ref, payload);
  else await updateDoc(ref, payload);
}

async function getLeaderboard(groupId, category){
  const g = groupId || DEFAULT_GROUP_ID;
  const col = collection(db, "groups", g, "players");
  let q, rows = [];
  if(category==="fastest"){
    // nur sinnvolle Bl√∂cke
    q = query(col,
      where("lastBlock.size", ">=", 10),
      where("lastBlock.accuracy", ">=", 80),
      orderBy("lastBlock.size", "desc"),
      orderBy("lastBlock.avgTime", "asc"),
      limit(20)
    );
    const snap = await getDocs(q);
    rows = snap.docs.map(d => {
      const x = d.data();
      return { nickname:x.nickname, value:(x.lastBlock?.avgTime?.toFixed?.(2) || "‚Äî")+" s",
        legendPrestige:x.legendPrestige||0, note:`Gr√∂√üe ${x.lastBlock?.size||0}, ${x.lastBlock?.accuracy||0}%` };
    });
  } else if(category==="tasks"){
    q = query(col, orderBy("totalTasks","desc"), limit(20));
    const snap = await getDocs(q);
    rows = snap.docs.map(d => { const x=d.data(); return { nickname:x.nickname, value:x.totalTasks||0, legendPrestige:x.legendPrestige||0, note:"Aufgaben gesamt" };});
  } else if(category==="xp"){
    q = query(col, orderBy("totalXP","desc"), limit(20));
    const snap = await getDocs(q);
    rows = snap.docs.map(d => { const x=d.data(); return { nickname:x.nickname, value:x.totalXP||0, legendPrestige:x.legendPrestige||0, note:"XP gesamt" };});
  } else { // streak
    q = query(col, orderBy("bestStreak","desc"), limit(20));
    const snap = await getDocs(q);
    rows = snap.docs.map(d => { const x=d.data(); return { nickname:x.nickname, value:x.bestStreak||0, legendPrestige:x.legendPrestige||0, note:"Beste Serie" };});
  }
  return rows;
}

// API ins Window h√§ngen, damit das Nicht-ESM-Script sie nutzen kann.
window.firebaseApi = { ensureAuth, shareBlock, getLeaderboard };
</script>

</body>
</html>
