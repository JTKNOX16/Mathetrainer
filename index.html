<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Johanns Personal Mathetrainer</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#0b1020;
      --card:#141a2e;
      --muted:#94a3b8;
      --accent:#0ea5e9;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --ring:#38bdf8;
      --text:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b1020 0%,#0f172a 100%);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:980px;margin:0 auto;padding:16px}
    /* Topbar */
    .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:12px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;font-size:clamp(18px,3.5vw,28px);letter-spacing:.4px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#0ea5e933,#22d3ee22);border:1px solid #22d3ee44;padding:6px 10px;border-radius:999px;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:linear-gradient(180deg,#0f172a,#0b1222);border:1px solid #33415555;border-radius:16px;padding:14px;box-shadow:0 10px 30px #00000040}
    .hud{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    .hud .tile{background:#0b1222;border:1px solid #33415555;border-radius:12px;padding:10px;text-align:center}
    .hud .tile .k{font-size:12px;color:var(--muted)}
    .hud .tile .v{font-weight:700;font-size:20px;margin-top:2px}
    .stage{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:860px){.stage{grid-template-columns:1fr}}
    .coach{display:flex;gap:12px;align-items:center}
    .coach-ava{width:56px;height:56px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#22d3ee,#0ea5e9);border:2px solid #22d3eeaa;display:grid;place-items:center;box-shadow:0 6px 18px #0891b233}
    .coach-ava svg{filter:drop-shadow(0 2px 2px #0008)}
    .banner{flex:1;background:linear-gradient(135deg,#0ea5e922,#22d3ee11);border:1px dashed #22d3ee66;border-radius:14px;padding:10px 12px}
    .banner .h{font-weight:700}
    .controls .group{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:#0b1222;border:1px solid #33415577;border-radius:12px;padding:10px 12px;color:var(--text);cursor:pointer}
    .btn:hover{border-color:#22d3eeaa;box-shadow:0 0 0 2px #22d3ee22 inset}
    .btn.primary{background:linear-gradient(135deg,#0ea5e9,#22d3ee);color:#041119;font-weight:800}
    .btn.ok{background:linear-gradient(135deg,#10b981,#34d399);color:#03160f}
    .btn.warn{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#1a1203}
    .select,.input{background:#0b1222;border:1px solid #33415577;color:var(--text);border-radius:10px;padding:10px 12px}
    .q-card{min-height:150px;display:grid;gap:10px}
    .q{font-size:clamp(22px,4.6vw,36px);font-weight:800;text-align:center;letter-spacing:.5px}
    .answer{display:flex;gap:8px;justify-content:center}
    .help{font-size:12px;color:var(--muted)}
    .footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1222;border:1px solid #33415577;border-radius:10px;padding:6px 10px}
    dialog{border:none;border-radius:16px;max-width:800px;width:92%;background:#0b1222;color:var(--text);padding:0}
    dialog .dlg-head{padding:14px 16px;border-bottom:1px solid #33415566;font-weight:800}
    dialog .dlg-body{padding:16px}
    dialog .dlg-foot{padding:12px 16px;border-top:1px solid #33415566;display:flex;justify-content:flex-end}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #33415555;text-align:left}
    .spark{height:40px;width:100%;display:block}
    .sr-only{position:absolute;left:-9999px}
    .switch{display:inline-flex;gap:8px;align-items:center}
    .switch input{appearance:none;width:42px;height:24px;border-radius:999px;background:#1f2937;position:relative;outline:none;border:1px solid #334155;cursor:pointer}
    .switch input:checked{background:#22d3ee55;border-color:#22d3eeaa}
    .switch input::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#e5e7eb;transition:all .2s}
    .switch input:checked::after{left:22px;background:#041119}
    .tag{font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid #334155aa;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="container">
    <!-- Topbar -->
    <div class="topbar">
      <div class="title">
        <span style="display:inline-grid;place-items:center;width:30px;height:30px;border-radius:8px;background:radial-gradient(circle at 30% 30%,#22d3ee,#0ea5e9);border:1px solid #22d3ee77;box-shadow:0 4px 12px #0891b233">‚ûó</span>
        <span>Johanns Personal Mathetrainer</span>
        <span class="pill"><span id="rankName">Recruit</span> <span class="tag" id="rankBadge">Rang: Recruit</span></span>
      </div>
      <div class="row">
        <label class="switch" title="Sprachausgabe an/aus">
          <input id="ttsToggle" type="checkbox" />
          <span>Sprachausgabe</span>
        </label>
        <button id="btnStats" class="btn">üìä Statistik</button>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="tile"><div class="k">Profil</div><div class="v" id="hudProfile">‚Äì</div></div>
      <div class="tile"><div class="k">XP</div><div class="v" id="hudXP">0</div></div>
      <div class="tile"><div class="k">Streak</div><div class="v" id="hudStreak">0</div></div>
      <div class="tile"><div class="k">Genauigkeit</div><div class="v" id="hudAcc">‚Äì</div></div>
    </div>

    <div class="stage">
      <!-- Coach Banner -->
      <div class="card">
        <div class="coach">
          <div class="coach-ava" aria-hidden="true">
            <!-- kleiner Comic Kopf -->
            <svg width="34" height="34" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="#022c3a"/>
              <circle cx="9" cy="10" r="1.4" fill="#22d3ee"/>
              <circle cx="15" cy="10" r="1.4" fill="#22d3ee"/>
              <path d="M8 15c1.5 1 3 1.5 4 1.5s2.5-.5 4-1.5" stroke="#22d3ee" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="banner">
            <div class="h" id="coachHeadline">Let‚Äôs go! 5 saubere Aufgaben = 1 ‚≠ê</div>
            <div class="p" id="coachText" style="opacity:.9">Konzentriert arbeiten: Lies die Aufgabe, rechne im Kopf, antworte ‚Äì dann erst klicken.</div>
          </div>
        </div>
        <div class="footer" style="margin-top:10px">
          <div class="row">
            <select id="profileSelect" class="select"></select>
            <input id="profileName" class="input" placeholder="Neues Profil (Name)" />
            <button id="btnAddProfile" class="btn">+ Profil</button>
            <button id="btnDelProfile" class="btn warn">Profil l√∂schen</button>
          </div>
          <div class="badge" title="Prestige z√§hlt Durchl√§ufe">
            ‚óà Prestige: <span id="hudPrestige">0</span>
          </div>
        </div>
      </div>

      <!-- Aufgabe -->
      <div class="card q-card">
        <div class="row controls" style="justify-content:space-between">
          <div class="group">
            <button id="btnStart" class="btn primary">‚ñ∂Ô∏è Block starten</button>
            <button id="btnSkip" class="btn">‚è≠Ô∏è √úberspringen</button>
          </div>
          <div class="group">
            <span class="badge">Zeit <span id="hudTime">0.0s</span></span>
            <span class="badge">Block <span id="hudBlock">0/10</span></span>
          </div>
        </div>

        <div id="question" class="q">Bereit?</div>
        <div class="answer">
          <input id="answer" class="input" inputmode="numeric" placeholder="Antwort eingeben" style="min-width:140px;text-align:center;font-size:20px;font-weight:700" />
          <button id="btnCheck" class="btn ok">‚úÖ Pr√ºfen</button>
        </div>
        <div id="feedback" class="help">Tipp: ENTER = Pr√ºfen, STRG+‚Üí = √úberspringen</div>
      </div>
    </div>

    <div class="footer">
      <div>¬© 2025 ‚Äì A-Z Forst- und Gartenservice Meyer (Privatprojekt f√ºr Johann)</div>
      <div class="row">
        <span class="tag">Build: <span id="buildTag">v1.6</span></span>
        <span class="tag">PWA ready</span>
      </div>
    </div>
  </div>

  <!-- Statistik Dialog -->
  <dialog id="dlgStats">
    <div class="dlg-head">Lernstatistik ‚Äì <span id="statsProfile">‚Äì</span></div>
    <div class="dlg-body">
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;min-width:230px">
          <div class="h" style="font-weight:800;margin-bottom:6px">Kennzahlen</div>
          <table>
            <tbody>
              <tr><td>Aufgaben gel√∂st</td><td id="stSolved">0</td></tr>
              <tr><td>Richtig (gesamt)</td><td id="stCorrect">0</td></tr>
              <tr><td>Genauigkeit</td><td id="stAcc">‚Äì</td></tr>
              <tr><td>√ò Zeit pro Aufgabe</td><td id="stAvg">‚Äì</td></tr>
              <tr><td>Beste Serie</td><td id="stBestStreak">0</td></tr>
              <tr><td>Aktueller Rang</td><td id="stRank">Recruit</td></tr>
              <tr><td>Prestige</td><td id="stPrestige">0</td></tr>
            </tbody>
          </table>
        </div>
        <div class="card" style="flex:1.4;min-width:280px">
          <div class="h" style="font-weight:800;margin-bottom:6px">Entwicklung (letzte 30 Antworten)</div>
          <canvas id="sparkline" class="spark" width="600" height="40"></canvas>
          <div class="help">Punkte: 1 = richtig, 0 = falsch ‚Ä¢ Linie: kumulative Trefferquote</div>
        </div>
      </div>
    </div>
    <div class="dlg-foot">
      <button id="btnResetStats" class="btn warn">Statistik zur√ºcksetzen</button>
      <button id="btnCloseStats" class="btn">Schlie√üen</button>
    </div>
  </dialog>

  <!-- Optional: Firebase Config (falls vorhanden, nicht blockierend) -->
  <script>
    (async function tryFirebase(){
      try {
        await import('./firebase-config.js');
        // Falls ben√∂tigt: weitere Firebase-Initialisierung hier erg√§nzen
        console.info('Firebase config geladen.');
      } catch(e){
        // Kein Problem im lokalen Modus
      }
    })();
  </script>

  <script>
    /* ===========================
       Zustand & Utilities
       =========================== */
    const ui = {
      rankName: document.getElementById('rankName'),
      rankBadge: document.getElementById('rankBadge'),
      hudProfile: document.getElementById('hudProfile'),
      hudXP: document.getElementById('hudXP'),
      hudStreak: document.getElementById('hudStreak'),
      hudAcc: document.getElementById('hudAcc'),
      hudTime: document.getElementById('hudTime'),
      hudBlock: document.getElementById('hudBlock'),
      hudPrestige: document.getElementById('hudPrestige'),
      coachHeadline: document.getElementById('coachHeadline'),
      coachText: document.getElementById('coachText'),
      profileSelect: document.getElementById('profileSelect'),
      profileName: document.getElementById('profileName'),
      btnAddProfile: document.getElementById('btnAddProfile'),
      btnDelProfile: document.getElementById('btnDelProfile'),
      btnStart: document.getElementById('btnStart'),
      btnSkip: document.getElementById('btnSkip'),
      btnCheck: document.getElementById('btnCheck'),
      btnStats: document.getElementById('btnStats'),
      question: document.getElementById('question'),
      answer: document.getElementById('answer'),
      feedback: document.getElementById('feedback'),
      ttsToggle: document.getElementById('ttsToggle'),
      dlgStats: document.getElementById('dlgStats'),
      st: {
        profile: document.getElementById('statsProfile'),
        solved: document.getElementById('stSolved'),
        correct: document.getElementById('stCorrect'),
        acc: document.getElementById('stAcc'),
        avg: document.getElementById('stAvg'),
        best: document.getElementById('stBestStreak'),
        rank: document.getElementById('stRank'),
        prestige: document.getElementById('stPrestige'),
        spark: document.getElementById('sparkline'),
      }
    };

    const persist = {
      loadAll(){ try{ return JSON.parse(localStorage.getItem('mt_profiles')||'{}'); }catch{return {}} },
      saveAll(obj){ localStorage.setItem('mt_profiles', JSON.stringify(obj)); },
      active(){ return localStorage.getItem('mt_active')||''; },
      setActive(id){ localStorage.setItem('mt_active', id); },
      build(){ return localStorage.getItem('mt_build')||'v0'; },
      setBuild(tag){ localStorage.setItem('mt_build', tag); },
    };

    const state = {
      profileId: '',
      xp: 0,
      streak: 0,
      bestStreak: 0,
      correct: 0,
      attempts: 0,
      prestige: 0,
      history: [], // [{ok:bool, t:seconds}]
      block: { total:10, index:0, started:false, t0:0 },
      current: { a:0, b:0, op:'+', res:0 },
      tts: false,
    };

    function now(){ return performance.now(); }
    function speak(text){
      if(!state.tts) return;
      try{
        const clean = (text||'').replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu,''); // Emojis raus
        const u = new SpeechSynthesisUtterance(clean);
        u.lang = 'de-DE';
        u.rate = 1.0;
        u.pitch = 1.0;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch{}
    }

    /* ===========================
       Profile
       =========================== */
    function defaultProfile(name){
      return { id: crypto.randomUUID(), name, xp:0, streak:0, bestStreak:0, correct:0, attempts:0, prestige:0, history:[], tts:false };
    }
    function getProfiles(){ return persist.loadAll(); }
    function saveProfiles(p){ persist.saveAll(p); }
    function getActiveProfile(){
      const all=getProfiles(); const id=persist.active();
      if(id && all[id]) return all[id];
      const names = Object.values(all);
      return names[0]||null;
    }
    function setActiveProfile(id){
      const all=getProfiles();
      if(all[id]){ persist.setActive(id); loadProfileIntoState(all[id]); }
    }
    function loadProfileIntoState(p){
      state.profileId = p.id;
      state.xp = p.xp||0;
      state.streak = p.streak||0;
      state.bestStreak = p.bestStreak||0;
      state.correct = p.correct||0;
      state.attempts = p.attempts||0;
      state.prestige = p.prestige||0;
      state.history = Array.isArray(p.history)? p.history.slice(-200) : [];
      state.tts = !!p.tts;
      ui.ttsToggle.checked = state.tts;
      updateHUD();
    }
    function saveStateToProfile(){
      if(!state.profileId) return;
      const all=getProfiles();
      const p=all[state.profileId];
      if(!p) return;
      Object.assign(p,{
        xp:state.xp, streak:state.streak, bestStreak:state.bestStreak,
        correct:state.correct, attempts:state.attempts, prestige:state.prestige,
        history:state.history, tts:state.tts
      });
      saveProfiles(all);
    }
    function refreshProfileSelect(){
      const all=getProfiles(); const ids=Object.keys(all);
      ui.profileSelect.innerHTML='';
      ids.forEach(id=>{
        const opt=document.createElement('option');
        opt.value=id; opt.textContent=all[id].name;
        ui.profileSelect.appendChild(opt);
      });
      if(state.profileId){
        ui.profileSelect.value=state.profileId;
      }
      ui.hudProfile.textContent = all[state.profileId]?.name || '‚Äì';
    }

    /* ===========================
       Rang & Prestige
       =========================== */
    function getRank(xp){
      const tiers = [
        {name:'Recruit', req:0},
        {name:'Apprentice', req:50},
        {name:'Adept', req:120},
        {name:'Expert', req:240},
        {name:'Master', req:420},
        {name:'Legend', req:680},
      ];
      let r=tiers[0];
      for(const t of tiers){ if(xp>=t.req) r=t; else break; }
      return r;
    }
    function getPrestige(){ return state.prestige||0; }

    /* ===========================
       Aufgaben & Logik
       =========================== */
    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function nextTask(){
      const ops=['+','-','√ó','√∑'];
      const op = ops[rand(0,ops.length-1)];
      let a=rand(2,12), b=rand(2,12), res=0;
      if(op==='+'){ res=a+b; }
      else if(op==='-'){ if(b>a)[a,b]=[b,a]; res=a-b; }
      else if(op==='√ó'){ res=a*b; }
      else { // Division: ganzzahlig
        res=rand(2,12); b=rand(2,12); a=res*b;
        op='√∑';
      }
      state.current={a,b,op,res};
      ui.question.textContent = `${a} ${op} ${b} = ?`;
      ui.answer.value='';
      ui.answer.focus();
      speak(ui.question.textContent);
      state.block.t0 = now();
    }

    function startBlock(){
      state.block.index=0;
      state.block.started=true;
      ui.hudBlock.textContent = `0/${state.block.total}`;
      ui.hudTime.textContent = `0.0s`;
      ui.feedback.textContent = 'Viel Erfolg! 10 Aufgaben in Folge.';
      nextTask();
      updateHUD();
    }

    function checkAnswer(){
      if(!state.block.started) return;
      const val = Number(ui.answer.value.trim());
      const took = (now() - state.block.t0)/1000;
      const ok = Number.isFinite(val) && (val === state.current.res);
      state.attempts++;
      if(ok){
        state.correct++;
        state.streak++;
        state.bestStreak = Math.max(state.bestStreak, state.streak);
        state.xp += 5;
        ui.feedback.textContent = `‚úÖ Richtig! +5 XP ‚Ä¢ ${took.toFixed(1)}s`;
        speak('Richtig!');
      }else{
        state.streak=0;
        ui.feedback.textContent = `‚ùå Leider nein. Richtig w√§re ${state.current.res}.`;
        speak('Leider falsch.');
      }
      state.history.push({ok, t: took});
      state.history = state.history.slice(-300);

      state.block.index++;
      ui.hudBlock.textContent = `${Math.min(state.block.index, state.block.total)}/${state.block.total}`;
      ui.hudTime.textContent = `${took.toFixed(1)}s`;
      updateHUD();
      saveStateToProfile();

      if(state.block.index>=state.block.total){
        // Block Ende
        const allOk = state.history.slice(-state.block.total).every(h=>h.ok);
        if(allOk){
          state.xp += 20;
          ui.coachHeadline.textContent = 'Stark! Block fehlerfrei abgeschlossen. +20 XP';
          ui.coachText.textContent = 'Willst du Prestige? Bei Legend kannst du ‚Äûprestigen‚Äú und neu starten ‚Äì f√ºr ‚óà.';
          // Prestige Vorschlag
          maybeOfferPrestige();
        }else{
          ui.coachHeadline.textContent = 'Geschafft! N√§chster Block?';
          ui.coachText.textContent = 'Tipp: Konstanz schl√§gt Tempo. Erst korrekt, dann schneller werden.';
        }
        state.block.started=false;
        saveStateToProfile();
        updateHUD();
      }else{
        nextTask();
      }
    }

    function skipTask(){
      if(!state.block.started) return;
      state.streak=0;
      const took = (now()-state.block.t0)/1000;
      state.attempts++;
      state.history.push({ok:false,t:took});
      state.block.index++;
      ui.feedback.textContent = '‚è≠Ô∏è √úbersprungen.';
      ui.hudBlock.textContent = `${state.block.index}/${state.block.total}`;
      updateHUD();
      saveStateToProfile();
      if(state.block.index>=state.block.total){
        state.block.started=false;
        ui.coachHeadline.textContent='Block beendet (mit √úberspringen).';
        ui.coachText.textContent='Kein Problem. N√§chster Block wieder voll fokussiert.';
        updateHUD();
      }else{
        nextTask();
      }
    }

    function maybeOfferPrestige(){
      const r=getRank(state.xp);
      if(r.name!=='Legend') return;
      // einfache Prompt-Confirm
      setTimeout(()=>{
        if(confirm('Legend erreicht! Prestige aktivieren?\nDu bekommst ‚óà +1, XP werden zur√ºckgesetzt.')){
          state.prestige = (state.prestige||0)+1;
          state.xp = 0;
          state.streak = 0;
          saveStateToProfile();
          ui.coachHeadline.textContent='Prestige aktiviert!';
          ui.coachText.textContent='XP auf 0. Bonus ‚óà erhalten. Weiter geht‚Äôs ‚Äì noch sauberer rechnen.';
          updateHUD();
        }
      }, 150);
    }

    /* ===========================
       HUD Rendering
       =========================== */
    function updateHUD(){
      const acc = state.attempts>0 ? Math.round((state.correct/state.attempts)*100) : null;
      ui.hudXP.textContent = state.xp;
      ui.hudStreak.textContent = state.streak;
      ui.hudAcc.textContent = (acc==null? '‚Äì' : acc+'%');
      ui.hudPrestige.textContent = state.prestige||0;

      // Motivations-Text dynamisch
      if(state.streak>=5){
        ui.coachHeadline.textContent='üî• Lauf! Serie ‚â• 5';
        ui.coachText.textContent='Behalte das Tempo, aber bleib sauber. Qualit√§t vor Speed.';
      } else if(acc!==null && acc>=90){
        ui.coachHeadline.textContent='Pr√§zise! Genauigkeit ‚â• 90%';
        ui.coachText.textContent='Jetzt schrittweise schneller werden ‚Äì Ziel √ò < 5s.';
      }
    }

    /* ===== Prestige-Badge Rendering (sicher) ===== */
    function renderRankBadge(){
      const rank = getRank(state.xp);
      const prest = getPrestige ? getPrestige() : 0;
      let label = rank.name;
      if(rank.name==="Legend" && prest>0) label = `Legend ‚óà${prest}`;
      else if(rank.name!=="Legend" && prest>0) label = `${rank.name} ‚ü≤${prest+1}`;
      if (ui?.rankName) ui.rankName.textContent = label;
      if (ui?.rankBadge) ui.rankBadge.textContent = "Rang: " + label;
    }

    /* Hook updateHUD erst, wenn es existiert (safe hooking) */
    (function hookUpdateHud(){
      function tryHook(){
        if (typeof window.updateHUD === "function" && !window.updateHUD.__prestigeHooked) {
          const orig = window.updateHUD;
          window.updateHUD = function(){
            orig.apply(this, arguments);
            renderRankBadge();
          };
          window.updateHUD.__prestigeHooked = true;
          renderRankBadge();
        }
      }
      tryHook();
      window.addEventListener('load', tryHook);
    })();

    /* ===========================
       Statistik
       =========================== */
    function openStats(){
      const p = getActiveProfile();
      if(!p){ alert('Kein Profil. Bitte erst eines anlegen.'); return; }
      ui.st.profile.textContent = p.name;
      const solved = p.attempts||0;
      const correct = p.correct||0;
      const acc = solved? Math.round((correct/solved)*100):0;
      const avg = (p.history && p.history.length)? (p.history.reduce((s,h)=>s+h.t,0)/p.history.length):0;
      ui.st.solved.textContent = solved;
      ui.st.correct.textContent = correct;
      ui.st.acc.textContent = solved? acc+'%' : '‚Äì';
      ui.st.avg.textContent = solved? avg.toFixed(2)+'s':'‚Äì';
      ui.st.best.textContent = p.bestStreak||0;
      ui.st.rank.textContent = getRank(p.xp||0).name;
      ui.st.prestige.textContent = p.prestige||0;
      drawSpark(p.history||[]);
      ui.dlgStats.showModal();
    }
    function closeStats(){ ui.dlgStats.close(); }
    function resetStats(){
      if(!state.profileId) return;
      if(!confirm('Statistik wirklich zur√ºcksetzen?')) return;
      state.xp=0; state.streak=0; state.bestStreak=0; state.correct=0; state.attempts=0; state.history=[];
      saveStateToProfile(); updateHUD(); renderRankBadge(); openStats();
    }
    function drawSpark(hist){
      const c=ui.st.spark, ctx=c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      const n=Math.min(30, hist.length);
      const slice = hist.slice(-n);
      const w=c.width, h=c.height;
      // Punkte (0/1)
      for(let i=0;i<slice.length;i++){
        const x = (i/(n-1||1))*w;
        const y = h- (slice[i].ok? h*0.8 : h*0.2);
        ctx.beginPath(); ctx.arc(x, y, 2.5, 0, Math.PI*2); ctx.fillStyle='#22d3ee'; ctx.fill();
      }
      // kumulative Trefferquote
      let cum=0;
      ctx.beginPath();
      for(let i=0;i<slice.length;i++){
        cum += slice[i].ok?1:0;
        const rate = (cum/(i+1));
        const x=(i/(n-1||1))*w;
        const y=h - rate*h*0.9;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.lineWidth=2; ctx.strokeStyle='#38bdf8'; ctx.stroke();
    }

    /* ===========================
       Init & Events
       =========================== */
    function bootstrap(){
      // Build Tag bump (hilft bei PWA-Cache-Erkennung im UI)
      const build='v1.6';
      document.getElementById('buildTag').textContent=build;
      persist.setBuild(build);

      // Default-Profil erzeugen, falls leer
      let all=getProfiles();
      if(Object.keys(all).length===0){
        const p=defaultProfile('Johann');
        all[p.id]=p; saveProfiles(all); persist.setActive(p.id);
      }
      const active=getActiveProfile();
      if(active){ loadProfileIntoState(active); }

      refreshProfileSelect();
      renderRankBadge();

      // Events
      ui.btnAddProfile.onclick = ()=>{
        const name=(ui.profileName.value||'').trim();
        if(!name){ alert('Bitte Name eingeben.'); return; }
        const all=getProfiles();
        const p=defaultProfile(name);
        all[p.id]=p; saveProfiles(all); setActiveProfile(p.id);
        ui.profileName.value=''; refreshProfileSelect(); updateHUD(); renderRankBadge();
      };
      ui.btnDelProfile.onclick = ()=>{
        if(!state.profileId) return;
        const all=getProfiles();
        if(!confirm(`Profil "${all[state.profileId].name}" wirklich l√∂schen?`)) return;
        delete all[state.profileId];
        saveProfiles(all);
        const first = Object.keys(all)[0]||'';
        if(first){ setActiveProfile(first); } else {
          const p=defaultProfile('Profil 1'); all[p.id]=p; saveProfiles(all); setActiveProfile(p.id);
        }
        refreshProfileSelect(); updateHUD(); renderRankBadge();
      };
      ui.profileSelect.onchange = (e)=> setActiveProfile(e.target.value);

      ui.btnStart.onclick = startBlock;
      ui.btnSkip.onclick = skipTask;
      ui.btnCheck.onclick = checkAnswer;
      ui.answer.addEventListener('keydown', (e)=>{
        if(e.key==='Enter') checkAnswer();
      });
      document.addEventListener('keydown', (e)=>{
        if(e.ctrlKey && e.key==='ArrowRight') { e.preventDefault(); skipTask(); }
      });

      ui.ttsToggle.onchange = ()=>{
        state.tts = ui.ttsToggle.checked;
        saveStateToProfile();
        if(state.tts) speak('Sprachausgabe aktiviert.');
      };

      ui.btnStats.onclick = openStats;
      document.getElementById('btnCloseStats').onclick = closeStats;
      document.getElementById('btnResetStats').onclick = resetStats;

      // Erst-Ansicht
      ui.question.textContent='Dr√ºcke ‚ÄûBlock starten‚Äú, um loszulegen.';
      ui.feedback.textContent='Ziel: 10 Aufgaben. Sauber rechnen, dann Tempo erh√∂hen.';
    }

    window.addEventListener('load', bootstrap);

    /* ===========================
       PWA / Service Worker
       =========================== */
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('./service-worker.js').catch(console.warn);
      });
    }
  </script>

  <!-- Fallback: No-JS Hinweis -->
  <noscript>
    <div style="padding:12px;margin:12px;border:2px solid #ef4444;border-radius:10px;background:#1f2937;color:#fff">
      Diese App ben√∂tigt JavaScript.
    </div>
  </noscript>
</body>
</html>
