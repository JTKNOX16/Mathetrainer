<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Legends of Math</title>
<meta name="theme-color" content="#7c3aed" />
<link rel="manifest" href="manifest.json" />
<!-- Favicon hinzuf√ºgen -->
<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon.ico" />
<style>
  :root{
    --bg1:#0ea5e9; --bg2:#7c3aed; --bg3:#14b8a6;
    --panel:#0b1228; --muted:#9fb0d0; --text:#ffffff;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
  }
  html,body{height:100%}
  body{
    margin:0;
    padding-top: calc(10px + env(safe-area-inset-top));
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    background:
      radial-gradient(1100px 700px at 20% -10%, rgba(255,255,255,.12) 0, transparent 60%),
      radial-gradient(900px 600px at 120% 10%, rgba(255,255,255,.08) 0, transparent 60%),
      linear-gradient(135deg, var(--bg1), var(--bg2) 60%, var(--bg3));
    color:var(--text);
    font:16px/1.55 ui-rounded, system-ui, -apple-system, "SF Pro Rounded", "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    display:flex; align-items:flex-start; justify-content:center;
  }
  .app{ width:min(1120px, 98vw); }

  .comic-title{ display:flex; align-items:center; justify-content:center; margin:8px 0 10px; text-align:center; padding:6px 8px; }
  .comic-title h1{
    margin:0; font-weight:1000; letter-spacing:.5px; font-size: clamp(24px, 6vw, 44px); color:#fff;
    text-shadow:
      2px 2px 0 #ef4444, -2px 2px 0 #22c55e, 2px -2px 0 #60a5fa, -2px -2px 0 #f59e0b, 0 0 10px rgba(0,0,0,.35);
  }

  header{ display:flex; gap:14px; align-items:center; justify-content:space-between; margin:6px 0 10px; flex-wrap:wrap; }
  .title{display:flex; gap:12px; align-items:center}
  .logo{
    width:56px;height:56px;border-radius:16px;
    background: conic-gradient(from 0deg, #f97316, #f59e0b, #22c55e, #14b8a6, #60a5fa, #a78bfa, #f472b6, #f97316);
    position:relative; display:grid; place-items:center; box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .logo svg{ filter: drop-shadow(0 3px 6px rgba(0,0,0,.25)); }
  .brand h2{font-weight:900; font-size:clamp(16px,3.2vw,24px); margin:0}
  .brand p{color:#f3f4f6; opacity:.9; margin:.5px 0 0; font-size:13px}

  .panel{
    background:linear-gradient(180deg, rgba(3,7,30,.82), rgba(10,15,45,.9));
    border:2px solid rgba(255,255,255,.08);
    border-radius:18px; padding:16px; box-shadow:0 14px 36px rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
  }
  .grid{display:grid; gap:16px}
  .cols{grid-template-columns: 1.25fr .75fr}
  @media (max-width:900px){ .cols{grid-template-columns: 1fr} }

  .rankbar{height:14px; background:#0e1634; border:1px solid #29336b; border-radius:999px; overflow:hidden}
  .rankfill{height:100%; width:0%; background:linear-gradient(90deg, #34d399, #f59e0b, #60a5fa); transition:width .35s ease}
  .ranklabel{display:flex; justify-content:space-between; font-size:13px; color:#c7d2fe; margin:6px 4px 0}

  .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .chip{border:2px solid #2b376e; background:#0c1540; color:var(--text); padding:8px 10px; border-radius:12px; user-select:none; display:flex; align-items:center}
  .chip input,.chip select{margin-left:6px; accent-color:#f59e0b}
  .btn{
    border:2px solid #2b376e; background:linear-gradient(180deg,#1d2a6b,#141c4a); color:var(--text);
    padding:10px 14px; border-radius:14px; font-weight:800; letter-spacing:.2px;
    transition:transform .05s ease, filter .2s ease; user-select:none; cursor:pointer;
  }
  .btn:hover{ filter:brightness(1.06) }
  .btn:active{ transform:translateY(1px) }
  .btn.primary{ border-color:#1b7a3d; background:linear-gradient(180deg,#13a66a,#0d7b4c) }
  .btn.warn{ border-color:#7a5a1b; background:linear-gradient(180deg,#d97706,#b45309) }
  .btn.ghost{ background:linear-gradient(180deg,#101847,#0c1333); border-color:#39438a }
  .btn.small{ padding:6px 10px; font-weight:700; font-size:14px }

  .question{
    font-size: clamp(30px, 5.2vw, 50px); font-weight:900; letter-spacing:1px; text-align:center;
    padding:18px 12px; border-radius:16px; background:linear-gradient(160deg,#0f1a53,#0c1540);
    border:2px solid #2a3369;
  }
  .answerrow{display:flex; gap:10px; justify-content:center; align-items:center; margin-top:12px; flex-wrap:wrap}
  input[type="number"]{
    width:170px; font-size:30px; padding:12px 12px; border-radius:12px; border:2px solid #334155;
    background:#0b1228; color:var(--text); outline:none; text-align:center; font-weight:900;
  }
  .meta{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; color:#dbeafe; font-size:14px}
  .bigstat{display:grid; place-items:center; padding:14px; border-radius:12px; border:2px dashed #3b436f; background:#0d1848}
  .bigstat b{font-size:22px}

  .correct{color:var(--ok)} .wrong{color:#fb7185} .neutral{color:#d1d5db}

  .footer{display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:8px; flex-wrap:wrap}
  .hint{color:#c7d2fe; font-size:13px}
  .kbd{padding:2px 6px; border:1px solid #334155; border-radius:6px; background:#0b1225; font-size:12px; color:#e5e7eb}

  .badge{ padding:8px 12px; border-radius:999px; border:2px solid #3a3f86; background:linear-gradient(180deg,#0f1a53,#0b133b); font-weight:900; }

  .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:30}
  .confetti i{position:absolute; width:6px; height:10px; background:currentColor; opacity:.9; transform:translateY(-20px); animation: fall 1000ms linear forwards}
  @keyframes fall{ to{ transform:translateY(100vh) rotate(220deg); opacity:.1 } }

  .coach{ display:flex; align-items:flex-end; gap:12px; }
  .coach-avatar{ width:110px; height:110px; border-radius:22px; display:grid; place-items:center;
    background: radial-gradient(circle at 30% 20%, #fef08a, #f59e0b 60%, #b45309);
    border:3px solid rgba(0,0,0,.25); box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  .bubble{ max-width: 600px; background:#0b133b; border:2px solid #39438a; padding:12px 14px; border-radius:12px; position:relative; font-size:16px; }
  .bubble:after{ content:""; position:absolute; left:-10px; bottom:14px; width:0; height:0; border-top:10px solid transparent; border-bottom:10px solid transparent; border-right:12px solid #39438a; }
  .tipbtn{ display:none; } .tipbtn.show{ display:inline-flex; animation:pulse 1.2s infinite; }
  @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1)} }

  .motivation{
    display:none; align-items:center; gap:12px; padding:10px 12px; border-radius:14px;
    border:2px solid #39438a; background:linear-gradient(180deg,#0f1a53,#0b133b);
    box-shadow:0 10px 24px rgba(0,0,0,.35); animation: pop 200ms ease; margin-bottom:12px;
  }
  .motivation.show{ display:flex; }
  @keyframes pop{ from{ transform:scale(.98); opacity:0 } to{ transform:scale(1); opacity:1 } }
  .mot-avatar{ width:92px; height:92px; border-radius:18px; display:grid; place-items:center; background:#0b1228; border:2px solid #3a3f86 }
  .mot-text{ font-size: clamp(18px,3.4vw,28px); font-weight:1000; letter-spacing:.2px; }

  .result-overlay{ position:fixed; inset:0; display:none; place-items:center; pointer-events:none; z-index:25 }
  .result-overlay.show{ display:grid; animation: fadeOut 1200ms 1000ms forwards; }
  @keyframes fadeOut{ to{ opacity:0; transform:scale(.98) } }
  .thumb{ display:grid; place-items:center; width:220px; height:220px; border-radius:50%;
    box-shadow:0 20px 60px rgba(0,0,0,.4); border:6px solid rgba(255,255,255,.25);
    font-size:140px; line-height:1; }
  .thumb.good{ background: radial-gradient(circle, #16a34a, #15803d); }
  .thumb.bad{ background: radial-gradient(circle, #ef4444, #b91c1c); }
  .thumb-wrap{ display:grid; place-items:center; gap:10px }
  .thumb-wrap .msg{ font-size:clamp(22px, 3.2vw, 34px); font-weight:900; text-align:center; text-shadow:0 2px 10px rgba(0,0,0,.35) }

  .toast{ position: fixed; left: 50%; transform: translateX(-50%); top: 16px; background: #0b133b; border:2px solid #39438a; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.2px; display:none; z-index:28 }
  .toast.show{ display:block; animation: slideDown 200ms ease, fadeOut 2000ms 1800ms forwards; }

  .blockbar{height:12px; background:#101847; border:2px solid #2b376e; border-radius:999px; overflow:hidden}
  .blockfill{height:100%; width:0%; background:linear-gradient(90deg,var(--info),var(--ok)); transition:width .25s ease}

  .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:40 }
  .modal .box{ background:#0b133b; border:2px solid #39438a; border-radius:16px; padding:18px; width:min(820px, 96vw); }
  .modal.show{ display:grid; }

  .avatar-grid{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px }
  .avatar{ border:2px solid #39438a; border-radius:14px; background:#0f1a53; display:grid; place-items:center; padding:8px; cursor:pointer; }
  .avatar.selected{ outline:3px solid var(--ok); }
  @media (max-width:520px){ .avatar-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }

  /* Stats layout */
  .stats-grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
  .stats-cards{ display:grid; gap:10px; grid-template-columns: repeat(3, 1fr); }
  .card{ background:#0b133b; border:2px solid #39438a; border-radius:12px; padding:12px; text-align:center }
  .card b{ font-size:22px }
  @media (max-width:760px){ .stats-cards{ grid-template-columns: 1fr 1fr; } }
  @media (max-width:520px){ .stats-cards{ grid-template-columns: 1fr; } }
  canvas{ width:100%; height:240px; background:#0a1232; border:2px solid #2b376e; border-radius:12px }

  /* Footer */
  .app-footer{ display:flex; justify-content:space-between; align-items:center; color:#dbeafe; font-size:12px; margin:10px 0 4px; opacity:.9 }
</style>
</head>
<body>
<div class="app">

  <div class="comic-title"><h1>Legends of Math</h1></div>

  <header>
    <div class="title">
      <div class="logo" aria-hidden="true" title="LoM">
        <svg width="40" height="40" viewBox="0 0 64 64" aria-hidden="true">
          <path d="M8 46 L56 46 L52 24 L40 34 L32 18 L22 34 L12 24 Z" fill="#fde047" stroke="#a16207" stroke-width="3" />
          <circle cx="12" cy="24" r="3" fill="#f472b6"></circle>
          <circle cx="32" cy="18" r="3" fill="#60a5fa"></circle>
          <circle cx="52" cy="24" r="3" fill="#34d399"></circle>
          <text x="32" y="58" text-anchor="middle" font-family="ui-rounded, system-ui" font-weight="900" font-size="18" fill="#fff">LoM</text>
        </svg>
      </div>
      <div class="brand">
        <h2>Legends of Math</h2>
        <p>Plus ‚Ä¢ Minus ‚Ä¢ Mal ‚Ä¢ Geteilt ‚Äì mit R√§ngen, Prestige & Kenji-Tipps</p>
      </div>
    </div>

    <div class="controls">
      <span class="chip">Profil:
        <select id="profileSelect" style="background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px;min-width:160px"></select>
      </span>
      <button class="btn small" id="manageProfilesBtn">Profile‚Ä¶</button>
      <button class="btn small" id="statsBtn">Statistik‚Ä¶</button>

      <label class="chip" title="Sprachausgabe"><input type="checkbox" id="speechToggle"> Sprachausgabe</label>

      <span class="chip">Gruppe:
        <input id="groupInput" placeholder="CLASS-3A" style="margin-left:6px;background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px;min-width:120px" />
        <button class="btn small" id="setGroupBtn">Setzen</button>
      </span>

      <label class="chip" title="Online-Teilnahme (Opt-in)">
        <input type="checkbox" id="shareToggle"> Online teilen
      </label>

      <button class="btn small" id="leaderboardBtn">üåê Bestenliste</button>

      <div id="rankBadge" class="badge">Rang: Rookie</div>
    </div>
  </header>

  <div class="panel motivation" id="motivation">
    <div class="mot-avatar" id="motAvatar"></div>
    <div class="mot-text" id="motText">Los geht‚Äôs!</div>
  </div>

  <div class="panel grid cols" role="region" aria-label="Spielbereich">
    <section class="grid" aria-live="polite">
      <div class="question" id="question">Bereit?</div>
    <form class="answerrow" id="answerForm" autocomplete="off" novalidate>
  <input id="answer" type="number" inputmode="numeric" step="1" pattern="[0-9]*" aria-label="Antwort eingeben" />
  <button class="btn primary" id="submitBtn" type="submit">Antwort pr√ºfen ‚èé</button>
  <button class="btn ghost" id="skipBtn" type="button" title="Neue Aufgabe (ohne Wertung)">√úberspringen</button>
  <button class="btn warn tipbtn" id="tipBtn" type="button">üí° Tipp anzeigen</button>
</form>


      <div class="coach" id="coachBox" style="display:none">
        <div class="coach-avatar" aria-hidden="true" id="kenjiAvatar"></div>
        <div class="bubble" id="tipBubble">üí° <b>Kenji:</b> Ich habe einen Tipp ‚Äì probier mal das Zerlegen in Zehner!</div>
      </div>

      <div class="meta" id="feedback"><span class="neutral">Viel Erfolg! üß†</span></div>

      <div class="grid cols">
        <div class="bigstat">Genauigkeit<br><b id="acc">100%</b></div>
        <div class="bigstat">Serie (Streak)<br><b id="streak">0</b></div>
      </div>

      <div class="grid" id="timingStats">
        <div class="bigstat">√ò Zeit<br><b id="avgTime">0.0s</b></div>
        <div class="bigstat">Letzte Zeit<br><b id="lastTime">0.0s</b></div>
      </div>

      <div class="grid">
        <div class="blockbar" title="Block-Fortschritt"><div class="blockfill" id="blockFill"></div></div>
        <div class="rankbar" aria-hidden="true"><div class="rankfill" id="rankfill"></div></div>
        <div class="ranklabel"><span id="rankName">Rookie</span><span id="xpLabel">0 / 100 XP</span></div>
      </div>

      <div class="footer">
        <div class="hint">Tipp: <span class="kbd">Enter</span> = pr√ºfen, <span class="kbd">Space</span> = √ºberspringen</div>
        <div class="controls">
          <span class="chip">Block:
            <select id="blockSize" style="background:#0b1225;color:var(--text);border:2px solid #334155;border-radius:10px;padding:6px">
              <option>10</option><option selected>15</option><option>20</option>
            </select>
          </span>
          <button class="btn small primary" id="startBlockBtn">Block starten</button>
          <button class="btn small" id="resetBtn">Fortschritt zur√ºcksetzen</button>
          <button class="btn small warn" id="celebrateBtn">ü•≥ Rang-Party</button>
        </div>
      </div>
    </section>

    <aside class="grid" role="region" aria-label="Einstellungen">
      <h3 style="margin:0">Einstellungen</h3>
      <div class="controls">
        <label class="chip"><input type="checkbox" id="op_add" checked> Plus</label>
        <label class="chip"><input type="checkbox" id="op_sub" checked> Minus</label>
        <label class="chip"><input type="checkbox" id="op_mul" checked> Mal</label>
        <label class="chip"><input type="checkbox" id="op_div" checked> Geteilt (ganzzahlig)</label>
      </div>

      <div class="controls">
        <span class="chip">Modus:
          <select id="mode" style="background:#0b1225;color:var(--text);border:2px solid #334155;border-radius:10px;padding:6px">
            <option value="adaptive" selected>Adaptiv (empfohlen)</option>
            <option value="fixed">Fixe Schwierigkeit</option>
          </select>
        </span>
        <span class="chip">Level:
          <input id="level" type="range" min="1" max="10" value="3" />
          <span id="levelLabel">3</span>
        </span>
      </div>

      <div class="panel" style="border-style:dashed">
        <div style="font-weight:900; margin-bottom:6px">Cloud & Gruppe</div>
        <div class="controls">
          <label class="chip"><input type="checkbox" id="autoPublishToggle"> Am Blockende automatisch ver√∂ffentlichen</label>
          <span class="chip">Gruppe aktuell: <b id="groupBadge">‚Äì</b></span>
          <button class="btn" id="openLeaderboardBtn">üåê Bestenliste ansehen</button>
        </div>
        <div style="font-size:13px; color:var(--muted)">Online-Teilen ist optional (Opt-in). Ver√∂ffentlichung erfolgt anonym.</div>
      </div>

      <div class="panel" style="border-style:dashed">
        <div style="font-weight:900; margin-bottom:6px">Rangfolge</div>
        <ol style="margin:0 0 6px 18px; padding:0; line-height:1.4">
          <li>Rookie (0‚Äì99)</li><li>Apprentice (100‚Äì249)</li><li>Challenger (250‚Äì499)</li>
          <li>Scholar (500‚Äì899)</li><li>Master (900‚Äì1499)</li><li>Grandmaster (1500‚Äì2399)</li><li>Legend (2400+)</li>
        </ol>
      </div>
    </aside>
  </div>

  <div class="confetti" id="confetti" aria-hidden="true"></div>
  <div class="result-overlay" id="resultOverlay" aria-hidden="true">
    <div class="thumb-wrap">
      <div class="thumb" id="thumbEl">üëç</div>
      <div class="msg" id="thumbMsg"></div>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <!-- Profile modal -->
  <div class="modal" id="profilesModal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 8px">Profile verwalten</h2>
      <div class="grid" style="grid-template-columns:1fr; gap:10px">
        <div class="controls">
          <span class="chip">Name:<input id="profileName" placeholder="Name eingeben" style="margin-left:6px;background:#0b1225;color:#fff;border:2px solid #334155;border-radius:10px;padding:6px;min-width:160px"/></span>
          <button class="btn primary" id="saveProfileBtn">Speichern / Neues Profil</button>
          <button class="btn ghost" id="closeProfilesBtn">Schlie√üen</button>
        </div>
        <div>Avatar w√§hlen:</div>
        <div class="avatar-grid" id="avatarGrid"></div>
      </div>
    </div>
  </div>

  <!-- Stats modal -->
  <div class="modal" id="statsModal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 8px">Lernstatistik</h2>
      <div class="stats-grid">
        <div class="stats-cards">
          <div class="card">Gel√∂ste Aufgaben<br><b id="stTotal">0</b></div>
          <div class="card">Genauigkeit<br><b id="stAcc">0%</b></div>
          <div class="card">√ò Zeit<br><b id="stAvg">0.0s</b></div>
          <div class="card">Beste Serie<br><b id="stBest">0</b></div>
          <div class="card">Aktuelle Serie<br><b id="stStreak">0</b></div>
          <div class="card">XP<br><b id="stXP">0</b></div>
        </div>
        <div>
          <div style="margin:10px 0 6px; font-weight:800">Entwicklung ‚Äì Sparkline (30)</div>
          <canvas id="chartSpark" width="760" height="120" aria-label="Sparkline"></canvas>
        </div>
        <div class="controls" style="justify-content:flex-end">
          <button class="btn ghost" id="exportCsvBtn">CSV exportieren</button>
          <button class="btn primary" id="closeStatsBtn">Schlie√üen</button>
        </div>
        <div id="statsHint" style="font-size:13px; color:#9fb0d0"></div>
      </div>
    </div>
  </div>

  <!-- Leaderboard modal -->
  <div class="modal" id="leaderboardModal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 8px">üåê Bestenliste ‚Äì <span id="lbGroup">‚Äì</span></h2>
      <div id="lbInfo" style="font-size:13px; color:#9fb0d0; margin-bottom:8px">Anonyme Teilnahme. Es werden Profilname, Gruppe und Leistungswerte gezeigt.</div>
      <div style="overflow:auto; max-height:60vh">
        <table style="width:100%; border-collapse:collapse">
          <thead>
            <tr style="text-align:left">
              <th>#</th><th>Profil</th><th>XP</th><th>Prestige</th><th>Accuracy</th><th>Best Streak</th><th>Zuletzt</th>
            </tr>
          </thead>
          <tbody id="lbBody">
            <tr><td colspan="7" style="opacity:.8">Lade‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
      <div class="controls" style="justify-content:flex-end; margin-top:10px">
        <button class="btn" id="closeLeaderboardBtn">Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Publish consent modal -->
  <div class="modal" id="publishModal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 8px">Ergebnis ver√∂ffentlichen?</h2>
      <div id="publishSummary" style="margin-bottom:10px"></div>
      <label class="chip"><input type="checkbox" id="publishAlways"> In Zukunft automatisch ver√∂ffentlichen</label>
      <div class="controls" style="justify-content:flex-end; margin-top:10px">
        <button class="btn" id="publishNoBtn">Nicht ver√∂ffentlichen</button>
        <button class="btn primary" id="publishYesBtn">Ver√∂ffentlichen</button>
      </div>
    </div>
  </div>

  <div class="app-footer">
    <div>¬© 2025 ‚Äì T-NOX</div>
    <div id="buildTag">Build v3.0-premium</div>
  </div>
</div>

<!-- Scripts folgen in Segment 3‚Äì5 -->
<!-- Firebase Bridge (ES-Module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
  import { firebaseConfig, DEFAULT_GROUP_ID } from "./firebase-config.js";

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUid = null;

  try {
    await signInAnonymously(auth);
  } catch (e) {
    // Falls schon angemeldet oder offline ‚Äì nicht kritisch
    console.warn("Anonymous sign-in skipped:", e?.message || e);
  }

  onAuthStateChanged(auth, (user) => {
    currentUid = user ? user.uid : null;
    console.info("Firebase verbunden:", !!user);
  });

  // --- Firestore Helpers ---
 async function pushScore(payload){
  if(!currentUid) throw new Error("Not authenticated");
  const doc = {
    ...payload,
    uid: currentUid,           // <‚Äî wichtig f√ºr Rules
    ts: serverTimestamp()
  };
  await addDoc(collection(db, "leaderboard"), doc);
  return true;
}


  async function fetchLeaderboard(groupId, max=25){
    const q = query(
      collection(db, "leaderboard"),
      where("groupId", "==", groupId),
      orderBy("xp", "desc"),
      orderBy("ts", "desc"),
      limit(max)
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  // --- Public API f√ºr App-Script ---
  window.firebaseApi = {
    db,
    get groupId(){ return (localStorage.getItem("lom_group") || DEFAULT_GROUP_ID); },
    set groupId(val){ localStorage.setItem("lom_group", (val||"").toUpperCase()); },
    pushScore,
    fetchLeaderboard,
    defaultGroup: DEFAULT_GROUP_ID
  };
</script>
<!-- App Script (kein Modul) -->
<script>
/* ================== UI Refs & Helpers ================== */
const $ = s => document.querySelector(s);
const opsEls = { add:$("#op_add"), sub:$("#op_sub"), mul:$("#op_mul"), div:$("#op_div") };

const ui = {
  // core
  q: $("#question"), ans: $("#answer"), submit: $("#submitBtn"), skip: $("#skipBtn"),
  feedback: $("#feedback"), acc: $("#acc"), streak: $("#streak"),
  rankFill: $("#rankfill"), xpLabel: $("#xpLabel"), rankName: $("#rankName"), rankBadge: $("#rankBadge"),
  mode: $("#mode"), level: $("#level"), levelLabel: $("#levelLabel"),

  // timing & block
  avgTime: $("#avgTime"), lastTime: $("#lastTime"), blockFill: $("#blockFill"),
  blockSize: $("#blockSize"), startBlockBtn: $("#startBlockBtn"),

  // fx
  tipBtn: $("#tipBtn"), coachBox: $("#coachBox"), tipBubble: $("#tipBubble"),
  confetti: $("#confetti"), resultOverlay: $("#resultOverlay"),
  thumbEl: $("#thumbEl"), thumbMsg: $("#thumbMsg"), toast: $("#toast"),
  motivation: $("#motivation"), motAvatar: $("#motAvatar"), motText: $("#motText"),
  celebrate: $("#celebrateBtn"), reset: $("#resetBtn"), kenjiAvatar: $("#kenjiAvatar"),

  // profiles
  profilesModal: $("#profilesModal"), manageProfilesBtn: $("#manageProfilesBtn"),
  profileSelect: $("#profileSelect"), profileName: $("#profileName"),
  avatarGrid: $("#avatarGrid"), saveProfileBtn: $("#saveProfileBtn"), closeProfilesBtn: $("#closeProfilesBtn"),

  // stats
  statsBtn: $("#statsBtn"), statsModal: $("#statsModal"), closeStatsBtn: $("#closeStatsBtn"),
  stTotal: $("#stTotal"), stAcc: $("#stAcc"), stAvg: $("#stAvg"), stBest: $("#stBest"), stStreak: $("#stStreak"), stXP: $("#stXP"),
  chartSpark: $("#chartSpark"), statsHint: $("#statsHint"), exportCsvBtn: $("#exportCsvBtn"),

  // cloud / group
  speechToggle: $("#speechToggle"),
  groupInput: $("#groupInput"), setGroupBtn: $("#setGroupBtn"), groupBadge: $("#groupBadge"),
  shareToggle: $("#shareToggle"), autoPublishToggle: $("#autoPublishToggle"),
  leaderboardBtn: $("#leaderboardBtn"), openLeaderboardBtn: $("#openLeaderboardBtn"),
  leaderboardModal: $("#leaderboardModal"), lbGroup: $("#lbGroup"), lbBody: $("#lbBody"), closeLeaderboardBtn: $("#closeLeaderboardBtn"),

  // publish consent
  publishModal: $("#publishModal"), publishSummary: $("#publishSummary"),
  publishAlways: $("#publishAlways"), publishYesBtn: $("#publishYesBtn"), publishNoBtn: $("#publishNoBtn"),
};

const PRAISES = ["Mega! Weiter so!","Stark gel√∂st!","Du bist auf Kurs!","Wow ‚Äì blitzschnell!","Sauber gerechnet!"];
const ENCOURAGE = ["Knapp daneben ‚Äì du schaffst das!","Super Versuch! N√§chste klappt.","Nicht aufgeben ‚Äì Kenji glaubt an dich!","Kurz durchatmen und weiter!","Jeder Profi lag mal daneben. Weiter!"];
const RANKS = [
  {name:"Rookie", min:0,   max:99},
  {name:"Apprentice", min:100, max:249},
  {name:"Challenger", min:250, max:499},
  {name:"Scholar", min:500, max:899},
  {name:"Master", min:900, max:1499},
  {name:"Grandmaster", min:1500, max:2399},
  {name:"Legend", min:2400, max:Infinity},
];

const AVATAR_IDS = ["kenji","nova","sparky","astro"];

/* ================== Avatare ================== */
function avatarSVG(id){
  if(id==="nova") return `<svg viewBox="0 0 120 120" width="80" height="80">
    <defs><linearGradient id="skin" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#fed7aa"/><stop offset="1" stop-color="#fb923c"/></linearGradient></defs>
    <ellipse cx="60" cy="44" rx="26" ry="22" fill="url(#skin)"/>
    <path d="M34 44 C36 16, 86 16, 88 44 L80 36 C70 26, 50 26, 40 36 Z" fill="#38bdf8"/>
    <rect x="38" y="38" width="44" height="9" rx="5" fill="#a78bfa"/>
    <circle cx="50" cy="46" r="5" fill="#111"/><circle cx="70" cy="46" r="5" fill="#111"/>
    <path d="M45 56 Q60 64 75 56" stroke="#111" stroke-width="3" fill="none"/>
    <path d="M28 80 C44 72, 76 72, 92 80 L86 102 L34 102 Z" fill="#0ea5e9"/>
  </svg>`;
  if(id==="sparky") return `<svg viewBox="0 0 120 120" width="80" height="80">
    <defs><linearGradient id="skin2" x1="0" y="0" x2="1" y2="1"><stop offset="0" stop-color="#fde68a"/><stop offset="1" stop-color="#f59e0b"/></linearGradient></defs>
    <ellipse cx="60" cy="44" rx="26" ry="22" fill="url(#skin2)"/>
    <path d="M32 42 L88 42 L90 48 Q60 60 30 48 Z" fill="#f59e0b"/>
    <circle cx="50" cy="46" r="5" fill="#111"/><circle cx="70" cy="46" r="5" fill="#111"/>
    <path d="M45 56 Q60 62 75 56" stroke="#111" stroke-width="3" fill="none"/>
    <path d="M24 82 C44 70, 76 70, 96 82 L90 104 L30 104 Z" fill="#ef4444"/>
  </svg>`;
  if(id==="astro") return `<svg viewBox="0 0 120 120" width="80" height="80">
    <defs><linearGradient id="skin3" x1="0" y="0" x2="1" y2="1"><stop offset="0" stop-color="#fecaca"/><stop offset="1" stop-color="#fda4af"/></linearGradient></defs>
    <ellipse cx="60" cy="44" rx="26" ry="22" fill="url(#skin3)"/>
    <path d="M28 40 C40 20, 80 20, 92 40 Q80 36 60 36 Q40 36 28 40 Z" fill="#22c55e"/>
    <circle cx="50" cy="46" r="5" fill="#111"/><circle cx="70" cy="46" r="5" fill="#111"/>
    <rect x="38" y="38" width="44" height="9" rx="5" fill="#22c55e" opacity=".4"/>
    <path d="M42 58 Q60 66 78 58" stroke="#111" stroke-width="3" fill="none"/>
    <path d="M24 82 C44 74, 76 74, 96 82 L88 104 L32 104 Z" fill="#60a5fa"/>
  </svg>`;
  return `<svg viewBox="0 0 120 120" width="80" height="80">
    <defs><linearGradient id="skin4" x1="0" y="0" x2="1" y2="1"><stop offset="0" stop-color="#fed7aa"/><stop offset="1" stop-color="#fb923c"/></linearGradient></defs>
    <ellipse cx="60" cy="44" rx="26" ry="22" fill="url(#skin4)"/>
    <path d="M34 44 C36 16, 86 16, 88 44 L80 36 C70 26, 50 26, 40 36 Z" fill="#0ea5e9"/>
    <rect x="38" y="38" width="44" height="9" rx="5" fill="#7c3aed"/>
    <circle cx="50" cy="46" r="5" fill="#111"/><circle cx="70" cy="46" r="5" fill="#111"/>
    <path d="M45 56 Q60 64 75 56" stroke="#111" stroke-width="3" fill="none"/>
    <path d="M28 80 C44 72, 76 72, 96 80 L90 102 L34 102 Z" fill="#a78bfa"/>
  </svg>`;
}

/* ================== Kenji Posen ================== */
function kenjiIdleSVG(){ return `
  <svg width="92" height="92" viewBox="0 0 120 120">
    <defs><linearGradient id="sk" x1="0" y="0" x2="1" y2="1"><stop offset="0" stop-color="#fed7aa"/><stop offset="1" stop-color="#fb923c"/></linearGradient></defs>
    <ellipse cx="60" cy="46" rx="28" ry="24" fill="url(#sk)"/>
    <path d="M30 46 C32 16, 88 16, 90 46 L82 38 C72 26, 48 26, 38 38 Z" fill="#0ea5e9"/>
    <rect x="36" y="38" width="48" height="10" rx="5" fill="#7c3aed"/>
    <circle cx="50" cy="48" r="5" fill="#111"/><circle cx="70" cy="48" r="5" fill="#111"/>
    <path d="M44 58 Q60 68 76 58" stroke="#111" stroke-width="3" fill="none"/>
    <path d="M24 86 C44 76, 76 76, 96 86 L90 108 L30 108 Z" fill="#a78bfa"/>
  </svg>`; }
function kenjiThumbsUpSVG(){ return `
  <svg width="92" height="92" viewBox="0 0 140 120">
    <defs><linearGradient id="sk2" x1="0" y="0" x2="1" y2="1"><stop offset="0" stop-color="#fed7aa"/><stop offset="1" stop-color="#fb923c"/></linearGradient></defs>
    <ellipse cx="60" cy="46" rx="28" ry="24" fill="url(#sk2)"/>
    <path d="M30 46 C32 16, 88 16, 90 46 L82 38 C72 26, 48 26, 38 38 Z" fill="#0ea5e9"/>
    <rect x="36" y="38" width="48" height="10" rx="5" fill="#7c3aed"/>
    <circle cx="50" cy="48" r="5" fill="#111"/><circle cx="70" cy="48" r="5" fill="#111"/>
    <path d="M44 58 Q60 68 76 58" stroke="#111" stroke-width="3" fill="none"/>
    <path d="M82 68 C96 60, 106 60, 116 66" stroke="#fde047" stroke-width="8" fill="none" stroke-linecap="round"/>
    <path d="M116 66 q8 4 6 14 q-6 6 -12 0 q-2 -6 6 -14 Z" fill="#fde047" stroke="#a16207" stroke-width="3"/>
    <path d="M24 86 C44 76, 76 76, 96 86 L90 108 L30 108 Z" fill="#a78bfa"/>
  </svg>`; }
function kenjiDoubleThumbsSVG(){ return `
  <svg width="92" height="92" viewBox="0 0 160 120">
    <defs><linearGradient id="sk3" x1="0" y="0" x2="1" y2="1"><stop offset="0" stop-color="#fed7aa"/><stop offset="1" stop-color="#fb923c"/></linearGradient></defs>
    <ellipse cx="80" cy="46" rx="28" ry="24" fill="url(#sk3)"/>
    <path d="M50 46 C52 16, 108 16, 110 46 L102 38 C92 26, 68 26, 58 38 Z" fill="#0ea5e9"/>
    <rect x="56" y="38" width="48" height="10" rx="5" fill="#7c3aed"/>
    <circle cx="70" cy="48" r="5" fill="#111"/><circle cx="90" cy="48" r="5" fill="#111"/>
    <path d="M64 58 Q80 68 96 58" stroke="#111" stroke-width="3" fill="none"/>
    <path d="M44 70 C54 62, 60 62, 68 66" stroke="#fde047" stroke-width="8" fill="none" stroke-linecap="round"/>
    <path d="M36 66 q-8 4 -6 14 q6 6 12 0 q2 -6 -6 -14 Z" fill="#fde047" stroke="#a16207" stroke-width="3"/>
    <path d="M116 70 C106 62, 100 62, 92 66" stroke="#fde047" stroke-width="8" fill="none" stroke-linecap="round"/>
    <path d="M124 66 q8 4 6 14 q-6 6 -12 0 q-2 -6 6 -14 Z" fill="#fde047" stroke="#a16207" stroke-width="3"/>
    <path d="M44 86 C64 76, 96 76, 116 86 L110 108 L50 108 Z" fill="#a78bfa"/>
  </svg>`; }

/* ================== State / Profiles ================== */
const defaultStats = ()=>({xp:0,correct:0,total:0,streak:0,bestStreak:0,times:[],history:[], prestige:0});
let profiles = loadProfiles();
if(profiles.items.length===0){
  const id = "p1";
  profiles = {currentId:id, items:[{id, name:"Spieler", avatar:"kenji", settings:{speech:false,level:3}, stats:defaultStats()}]};
  saveProfiles();
}
populateProfileSelect();

let state = hydrateStateFromProfile();
applySettingsToUI();

let currentQ = null, tStart = 0, hintTimer = null, voice = null;
let block = { active:false, size:15, index:0, correct:0, total:0, times:[], xpEarned:0 };

/* ================== Events ================== */
ui.submit.addEventListener("click", check);
ui.skip.addEventListener("click", () => { feedbackNeutral("Aufgabe √ºbersprungen."); newQuestion(true); });
  // Form-Submit abfangen ‚Üí Enter and Klick auf "Pr√ºfen" f√ºhren immer zu check()
const answerForm = document.querySelector("#answerForm");
if (answerForm) {
  answerForm.addEventListener("submit", (e) => {
    e.preventDefault();
    check();
  });
}

// Im Eingabefeld nur Space (= √úberspringen) behandeln.
// Enter/NumpadEnter lassen wir durch ‚Üí das Formular l√∂st den Submit aus.
ui.ans.addEventListener("keydown", (e) => {
  if (e.code === "Space" || e.key === " ") {
    e.preventDefault();
    ui.skip.click();
  }
});


ui.reset.addEventListener("click", resetProgress);
ui.celebrate.addEventListener("click", celebrate);
ui.mode.addEventListener("change", () => { state.mode = ui.mode.value; persist(); });
ui.level.addEventListener("input", () => { ui.levelLabel.textContent = ui.level.value; });
ui.level.addEventListener("change", () => { state.level = +ui.level.value; persist(); newQuestion(true); });
for (const [k,el] of Object.entries(opsEls)){ el.addEventListener("change", ()=>{ state.ops[k]=el.checked; persist(); newQuestion(true); }); }
ui.tipBtn.addEventListener("click", () => { showStrategyTip(); });

ui.startBlockBtn.addEventListener("click", () => {
  block.size = +ui.blockSize.value;
  block.active = true; block.index = 0; block.correct = 0; block.total = 0; block.times = []; block.xpEarned = 0;
  updateBlockBar();
  speak("Block gestartet. Viel Erfolg!");
  showToast(`Block gestartet: ${block.size} Aufgaben`);
  newQuestion(true);
});

// Cloud/Group
ui.setGroupBtn.addEventListener("click", () => {
  const val = (ui.groupInput.value || "").trim().toUpperCase();
  if(!val){ showToast("Bitte Gruppen-ID eingeben."); return; }
  if(window.firebaseApi){ window.firebaseApi.groupId = val; }
  ui.groupBadge.textContent = val;
  showToast("Gruppe gesetzt.");
});
ui.leaderboardBtn.addEventListener("click", openLeaderboard);
ui.openLeaderboardBtn.addEventListener("click", openLeaderboard);
ui.closeLeaderboardBtn.addEventListener("click", () => ui.leaderboardModal.classList.remove("show"));
ui.shareToggle.addEventListener("change", saveSharePrefs);
ui.autoPublishToggle.addEventListener("change", saveSharePrefs);
ui.publishNoBtn.addEventListener("click", () => { ui.publishModal.classList.remove("show"); });
ui.publishYesBtn.addEventListener("click", async () => {
  ui.publishModal.classList.remove("show");
  if(ui.publishAlways.checked){ localStorage.setItem("lom_autopub","1"); ui.autoPublishToggle.checked = true; }
  await pushToCloudSafe();
});

// Profiles
ui.manageProfilesBtn.addEventListener("click", openProfiles);
ui.closeProfilesBtn.addEventListener("click", ()=> ui.profilesModal.classList.remove("show"));
ui.saveProfileBtn.addEventListener("click", saveOrCreateProfile);
ui.profileSelect.addEventListener("change", onProfileChange);

// Speech
ui.speechToggle.addEventListener("change", ()=>{ currentProfile().settings.speech = ui.speechToggle.checked; saveProfiles(); });

// Stats
ui.statsBtn.addEventListener("click", openStats);
ui.closeStatsBtn.addEventListener("click", ()=> ui.statsModal.classList.remove("show"));
ui.exportCsvBtn.addEventListener("click", exportCSV);

/* ================== Init ================== */
window.addEventListener("load", () => {
  initVoices();
  updateHUD();
  ui.kenjiAvatar.innerHTML = kenjiIdleSVG();
  // Defaults
  ui.blockSize.value = "15";
  if(window.firebaseApi){
    if(!localStorage.getItem("lom_group")) localStorage.setItem("lom_group", window.firebaseApi.defaultGroup||"CLASS-3A");
    ui.groupInput.value = localStorage.getItem("lom_group");
    ui.groupBadge.textContent = localStorage.getItem("lom_group");
  }
  ui.shareToggle.checked = localStorage.getItem("lom_share")==="1";
  ui.autoPublishToggle.checked = localStorage.getItem("lom_autopub")==="1";
  newQuestion();
  // PWA-Registrierung in Segment 5 (Service Worker) ‚Äì hier nur Feature-Check
  if('serviceWorker' in navigator){ /* done in segment 5 */ }
});

/* ================== Speech ================== */
function initVoices(){
  const pick = () => {
    if(!('speechSynthesis' in window)) return;
    const voices = speechSynthesis.getVoices() || [];
    const prefer = voices.find(v => /de[-_]/i.test(v.lang) && /Google|Microsoft|Apple|Premium|Natural/i.test(v.name));
    voice = prefer || voices.find(v => /de[-_]/i.test(v.lang)) || null;
  };
  if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = pick; pick(); }
}
function stripHtml(s){ const tmp = document.createElement("div"); tmp.innerHTML = s; return tmp.textContent || tmp.innerText || ""; }
function stripEmoji(text){ return text.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\p{Emoji}]/gu, "").trim(); }
function speak(text){
  if(!currentProfile().settings.speech) return;
  if(!("speechSynthesis" in window)) return;
  const clean = stripEmoji(stripHtml(text)); if(!clean) return;
  const u = new SpeechSynthesisUtterance(clean);
  u.lang = (voice && voice.lang) || "de-DE"; u.voice = voice || null; u.rate = 1; u.pitch = 1.05;
  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}

/* ================== SFX ================== */
let audioCtx = null;
function ensureAudio(){ if(audioCtx) return audioCtx; audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
function tone(freq=440, ms=150, type="sine", gain=0.06){
  const ctx = ensureAudio(), o = ctx.createOscillator(), g = ctx.createGain();
  o.type = type; o.frequency.value = freq; g.gain.value = gain; o.connect(g); g.connect(ctx.destination); o.start();
  g.gain.setValueAtTime(gain, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + ms/1000);
  o.stop(ctx.currentTime + ms/1000 + 0.02);
}
function sfxCorrect(){ tone(880,120,"triangle",0.07); setTimeout(()=>tone(1320,120,"triangle",0.06),110); }
function sfxWrong(){ tone(220,180,"sawtooth",0.06); setTimeout(()=>tone(160,200,"sawtooth",0.05),150); }
function sfxRank(){ tone(660,120,"square",0.06); setTimeout(()=>tone(990,140,"square",0.05),110); setTimeout(()=>tone(1320,160,"square",0.04),220); }

/* ================== Gameplay ================== */
function newQuestion(silent=false){
  if(!Object.values(state.ops || {add:true,sub:true,mul:true,div:true}).some(Boolean)){
    state.ops = {add:true,sub:true,mul:true,div:true}; opsEls.add.checked = true;
  }
  hideTip();
  const q = generateQuestion(getDifficulty());
  currentQ = q;
  ui.q.textContent = `${q.a} ${q.sym} ${q.b} = ?`;
  ui.ans.value = ""; ui.ans.focus();
  tStart = performance.now();
  scheduleHint();
  if(!silent){ feedbackNeutral(block.active ? `Aufgabe ${block.index+1||1}/${block.size}` : "Los geht's!"); showBanner("Kenji sagt: Viel Erfolg!", "neutral"); }
}

function getDifficulty(){
  if(state.mode==="fixed") return state.level;
  const acc = state.total ? (state.correct/state.total) : 1;
  let base = 1 + Math.floor(state.streak/4);
  if(acc > .9) base += 1; if(acc < .7) base = Math.max(1, base-1);
  return clamp(base, 1, 10);
}

function generateQuestion(level){
  const span = Math.round(Math.pow(level, 2) * 10);
  const allowed = []; if(state.ops?.add) allowed.push("add"); if(state.ops?.sub) allowed.push("sub"); if(state.ops?.mul) allowed.push("mul"); if(state.ops?.div) allowed.push("div");
  const op = allowed[Math.floor(Math.random()*allowed.length)];
  let a,b,ans,sym;
  if(op==="add"){ a = r(0, span); b = r(0, span); ans = a+b; sym = "+"; }
  else if(op==="sub"){ a = r(0, span); b = r(0, span); if(a<b) [a,b]=[b,a]; ans = a-b; sym = "‚àí"; }
  else if(op==="mul"){ const cap = Math.max(5, Math.round(span/10)); a = r(0, cap); b = r(0, cap); ans = a*b; sym = "√ó"; }
  else { const cap = Math.max(3, Math.round(span/12)); b = r(1, cap); const q = r(0, cap); a = b*q; ans = q; sym = "√∑"; }
  return {a,b,ans,sym,op};
}

function check(){
  const raw = ui.ans.value.trim(); if(raw===""){ feedbackNeutral("Bitte gib eine Zahl ein."); ui.ans.focus(); return; }
  const guess = Number(raw);
  const seconds = ((performance.now() - tStart)/1000);
  state.total = (state.total||0) + 1; state.times = state.times || []; state.times.push(seconds);

  const correct = (guess===currentQ.ans);
  if(correct){
    state.correct = (state.correct||0) + 1; state.streak = (state.streak||0) + 1; state.bestStreak = Math.max(state.bestStreak||0, state.streak);
    const gained = scoreFor(seconds, state.streak); state.xp = (state.xp||0) + gained;
    const praise = PRAISES[Math.floor(Math.random()*PRAISES.length)];
    feedbackCorrect(`Richtig! +${gained} XP ${speedText(seconds)} (Streak ${state.streak}) ‚Äì ${praise}`);
    visualResult(true, praise); showBanner(praise, "good", "thumbs"); sfxCorrect(); speak(praise);
    const rankedUp = maybeRankUp();
    if(block.active){ block.index++; block.total++; block.correct++; block.times.push(seconds); block.xpEarned += gained; updateBlockBar(); }
    addHistoryEntry(true, seconds);
    persist(); updateHUD(); hideTip();
    if(block.active && block.index>=block.size){ endBlock(); } else { setTimeout(()=>newQuestion(true), rankedUp ? 1200 : 550); }
  } else {
    const sol = currentQ.ans; const msg = ENCOURAGE[Math.floor(Math.random()*ENCOURAGE.length)];
    feedbackWrong(`Leider falsch. Richtige L√∂sung: <b>${sol}</b> ‚Äì ${msg}`);
    visualResult(false, msg); showBanner(msg, "bad", "doublethumbs"); sfxWrong(); speak(msg);
    state.streak = 0;
    if(block.active){ block.index++; block.total++; block.times.push(seconds); updateBlockBar(); }
    addHistoryEntry(false, seconds);
    persist(); updateHUD(); hideTip();
    if(block.active && block.index>=block.size){ endBlock(); } else { setTimeout(()=>newQuestion(true), 900); }
  }
}

function addHistoryEntry(ok, secs){
  const p = currentProfile();
  p.stats.history = p.stats.history || [];
  p.stats.history.push({ t: Date.now(), ok: !!ok, s: +secs.toFixed(3) });
}

/* ================== Tipps ================== */
function scheduleHint(){ clearTimeout(hintTimer); hintTimer = setTimeout(() => ui.tipBtn.classList.add("show"), 10000); }
function hideTip(){ clearTimeout(hintTimer); ui.tipBtn.classList.remove("show"); ui.coachBox.style.display = "none"; }
function showStrategyTip(){ const tip = strategyFor(currentQ); ui.tipBubble.innerHTML = "üí° <b>Kenji:</b> " + tip; ui.coachBox.style.display = "flex"; speak(tip); }

function strategyFor(q){
  if(!q) return "Atme tief durch, lies die Aufgabe laut vor und sch√§tze erst ‚Äì dann rechne.";
  const {a,b,op} = q;
  if(op==="add"){
    if((a%10)+(b%10) >= 10) return `Zehner√ºbergang: Rechne ${a} + ${b} als (${a} + ${10-(a%10)}) + (${b-(10-(a%10))}).`;
    return `Tauschaufgabe & Zerlegen: Rechne zuerst die gr√∂√üere Zahl und erg√§nze auf den n√§chsten Zehner.`;
  }
  if(op==="sub"){
    if((a%10) < (b%10)) return `Erg√§nzen: Denke ${a} ‚àí ${b} als ‚ÄûWie viel fehlt von ${b} zu ${a}?‚Äú. Erst bis zum vollen Zehner, dann weiter.`;
    return `Zerlegen: Rechne ${a} ‚àí ${b} in zwei Schritten: erst Einer, dann Zehner.`;
  }
  if(op==="mul"){
    if(a===0 || b===0) return "Alles mal Null ist Null.";
    if(a===1 || b===1) return "Alles mal Eins bleibt gleich.";
    const big = Math.max(a,b), small = Math.min(a,b);
    if(small===2) return `Verdoppeln: ${big}√ó2 = ${big+big}.`;
    if(small===5) return `√ó5 = Halbieren und √ó10: ${big}√ó5 = (${big}√∑2)√ó10.`;
    return `Zerlegen: ${a}√ó${b} = ${a}√ó(${Math.floor(b/2)} + ${Math.ceil(b/2)}) ‚Äì Teilprodukte addieren.`;
  }
  if(op==="div"){
    if(b===1) return `Teilen durch 1 √§ndert nichts.`;
    if(a===0) return `Null geteilt durch etwas ist Null.`;
    return `Umkehraufgabe: ‚ÄûWelche Zahl mal ${b} ergibt ${a}?‚Äú`;
  }
  return "Lies die Aufgabe noch einmal ‚Äì markiere wichtige Zahlen mit dem Finger.";
}

/* ================== Block-Ende & Consent ================== */
function endBlock(){
  const acc = block.total ? Math.round((block.correct/block.total)*100) : 0;
  const avg = block.times.length ? (block.times.reduce((a,b)=>a+b,0)/block.times.length) : 0;
  const accFactor = acc/100; const speedFactor = Math.min(1, 5/Math.max(0.001, avg));
  const bonus = Math.round(50 * 0.6*accFactor + 50 * 0.4*speedFactor);
  state.xp = (state.xp||0) + bonus; block.xpEarned += bonus;
  persist(); updateHUD();
  celebrate(); sfxRank(); showToast(`Block-Bonus: +${bonus} XP üéÅ`);
  speak(`Block abgeschlossen. ${block.correct} von ${block.total} richtig. Durchschnitt ${avg.toFixed(1)} Sekunden. Bonus ${bonus} Erfahrungspunkte. Super gemacht!`);
  // Reset
  block.active=false; block.index=0; updateBlockBar();
  // Consent
  maybePublishConsent(acc, avg, bonus);
}

function maybePublishConsent(acc, avg, bonus){
  const allowShare = localStorage.getItem("lom_share")==="1";
  const auto = localStorage.getItem("lom_autopub")==="1";
  if(!allowShare){ return; }
  if(auto){ pushToCloudSafe(); return; }

  // Consent-Dialog anzeigen
  const p = currentProfile();
  const sum = `
    <div>Profil: <b>${escapeHtml(p.name || "Spieler")}</b></div>
    <div>Gruppe: <b>${(window.firebaseApi?.groupId||"CLASS-3A")}</b></div>
    <div>Block: <b>${block.correct}/${block.total}</b> ¬∑ Genauigkeit <b>${acc}%</b> ¬∑ √ò Zeit <b>${avg.toFixed(1)}s</b></div>
    <div>Bonus: <b>+${bonus} XP</b> ¬∑ Gesamt XP <b>${state.xp}</b></div>
  `;
  ui.publishSummary.innerHTML = sum;
  ui.publishAlways.checked = false;
  ui.publishModal.classList.add("show");
}

async function pushToCloudSafe(force=false){
  try{
    const p = currentProfile();
    const payload = {
      profileName: p.name || "Spieler",
      groupId: (window.firebaseApi?.groupId || "CLASS-3A"),
      xp: p.stats?.xp || 0,
      prestige: p.stats?.prestige || 0,
      bestStreak: p.stats?.bestStreak || 0,
      accuracy: (p.stats?.total ? Math.round(100*(p.stats?.correct||0)/(p.stats?.total||1)) : 0),
      updatedAt: Date.now()
    };
    await window.firebaseApi?.pushScore(payload);
    console.info("Score in Cloud gespeichert", payload);
    showToast("Ergebnis online ver√∂ffentlicht ‚úÖ");
  }catch(e){
    console.warn("Cloud publish failed:", e);
    const msg = (e && e.message) ? e.message :
                (typeof e === 'string' ? e : 'Unbekannter Fehler');
    showToast("Ver√∂ffentlichung fehlgeschlagen: " + msg);
  }
}

function saveSharePrefs(){
  localStorage.setItem("lom_share", ui.shareToggle.checked ? "1":"0");
  localStorage.setItem("lom_autopub", ui.autoPublishToggle.checked ? "1":"0");
}
// ===== XP-Berechnung & Speed-Icon (wurde beim Mergen wohl ausgelassen) =====
function scoreFor(seconds, streak){
  const base = 10;
  let bonus = 0;
  if (seconds <= 3) bonus += 5;
  else if (seconds <= 6) bonus += 2;
  bonus += Math.min(streak, 10) * 1;
  return base + bonus;
}
function speedText(s){
  if (s <= 3) return "‚ö°";
  if (s <= 6) return "‚è±Ô∏è";
  return "";
}

  
/* ================== HUD / Rank / Prestige ================== */
function updateHUD(){
  const acc = state.total ? Math.round((state.correct/state.total)*100) : 100;
  ui.acc.textContent = acc + "%"; ui.streak.textContent = state.streak||0;

  const rank = getRank(state.xp||0); const next = nextRankThreshold(state.xp||0);
  const prest = (currentProfile().stats?.prestige||0);
  // Label inkl. Prestige (Legend ‚óàN bzw. Rank ‚ü≤(prest+1))
  let label = rank.name;
  if(rank.name==="Legend" && prest>0) label = `Legend ‚óà${prest}`;
  else if(rank.name!=="Legend" && prest>0) label = `${rank.name} ‚ü≤${prest+1}`;

  ui.rankName.textContent = label;
  ui.rankBadge.textContent = "Rang: " + label;

  if(next===Infinity){ ui.xpLabel.textContent = `${state.xp||0} XP ‚Äì Legend`; ui.rankFill.style.width = "100%"; }
  else{
    const currBase = rank.min; const span = next - currBase;
    const prog = clamp(((state.xp||0) - currBase)/span, 0, 1);
    ui.xpLabel.textContent = `${state.xp||0} / ${next} XP`; ui.rankFill.style.width = (prog*100).toFixed(1) + "%";
  }
  const last = state.times && state.times.length ? state.times[state.times.length-1] : 0;
  const avg = state.times && state.times.length ? state.times.reduce((a,b)=>a+b,0)/state.times.length : 0;
  ui.lastTime.textContent = last.toFixed(1) + "s"; ui.avgTime.textContent = avg.toFixed(1) + "s";

  // Prestige-Angebot
  if(rank.name==="Legend"){ setTimeout(maybeOfferPrestige, 50); }
}
window.updateHUD = updateHUD; // failsafe

function getRank(xp){ let current = RANKS[0]; for(const r of RANKS){ if(xp >= r.min) current = r; } return current; }
function nextRankThreshold(xp){ for(const r of RANKS){ if(xp < r.min) return r.min; } return Infinity; }

function maybeRankUp(){
  const prev = getRank((state.xp||0) - 1); const now = getRank(state.xp||0);
  if(now.name !== prev.name){
    const msg = `üèÜ Rangaufstieg: <b>${now.name}</b>! Gro√üartig ‚Äì bleib dran, du wirst richtig schnell!`;
    feedbackCorrect(msg); celebrate(); sfxRank(); showToast(`Neuer Rang: ${now.name} ‚ú® Weiter so!`);
    speak(`Neuer Rang ${now.name}. Tolle Leistung!`);
    showBanner(`Neuer Rang: ${now.name}!`, "good", "thumbs");
    return true;
  }
  return false;
}

function maybeOfferPrestige(){
  const rank = getRank(state.xp||0);
  if(rank.name!=="Legend") return;
  if (confirm("Legend erreicht! Prestige aktivieren?\nDu bekommst ‚óà +1, XP werden zur√ºckgesetzt.")) {
    const p = currentProfile();
    p.stats.prestige = (p.stats.prestige||0)+1;
    p.stats.xp = 0; // reset XP
    saveProfiles();
    state = hydrateStateFromProfile();
    updateHUD();
    showBanner("Prestige aktiviert! ‚óà +1", "good", "thumbs");
    pushToCloudSafe(true);
  }
}

/* ================== Visual FX & Banner ================== */
function celebrate(){
  const colors = ["#60a5fa","#22c55e","#f59e0b","#ef4444","#a78bfa","#34d399","#f472b6"];
  for(let i=0;i<150;i++){
    const piece = document.createElement("i");
    piece.style.left = Math.random()*100 + "vw";
    piece.style.color = colors[Math.floor(Math.random()*colors.length)];
    piece.style.animationDuration = 600 + Math.random()*1100 + "ms";
    piece.style.transform = `translateY(-20px) rotate(${Math.random()*180}deg)`;
    ui.confetti.appendChild(piece);
    setTimeout(()=> piece.remove(), 1900);
  }
}
function visualResult(ok, text){
  ui.resultOverlay.classList.remove("show");
  ui.thumbEl.className = "thumb " + (ok ? "good" : "bad");
  ui.thumbEl.textContent = ok ? "üëç" : "‚ú®";
  ui.thumbMsg.textContent = text;
  void ui.resultOverlay.offsetWidth; ui.resultOverlay.classList.add("show");
}
function showBanner(text, kind="neutral", pose="idle"){
  ui.motivation.classList.add("show");
  ui.motText.textContent = text;
  ui.motAvatar.innerHTML = (pose==="thumbs") ? kenjiThumbsUpSVG() :
                           (pose==="doublethumbs") ? kenjiDoubleThumbsSVG() : kenjiIdleSVG();
  ui.motivation.style.borderColor = kind==="good" ? "#22c55e" : kind==="bad" ? "#ef4444" : "#39438a";
}

/* ================== Profile-Logik ================== */
function populateProfileSelect(){
  ui.profileSelect.innerHTML = "";
  for(const p of profiles.items){
    const o = document.createElement("option"); o.value = p.id; o.textContent = p.name || "Spieler";
    if(p.id===profiles.currentId) o.selected = true; ui.profileSelect.appendChild(o);
  }
}
function onProfileChange(){
  profiles.currentId = ui.profileSelect.value; saveProfiles();
  state = hydrateStateFromProfile(); applySettingsToUI();
  updateHUD(); newQuestion(true);
}
function openProfiles(){
  ui.avatarGrid.innerHTML = "";
  AVATAR_IDS.forEach(id=>{
    const d = document.createElement("div"); d.className="avatar"; d.dataset.id=id; d.innerHTML = avatarSVG(id);
    if(currentProfile().avatar===id) d.classList.add("selected");
    d.addEventListener("click", ()=>{
      document.querySelectorAll(".avatar").forEach(a=>a.classList.remove("selected"));
      d.classList.add("selected"); ui.avatarGrid.dataset.selected = id;
    });
    ui.avatarGrid.appendChild(d);
  });
  ui.profileName.value = currentProfile().name || "";
  ui.avatarGrid.dataset.selected = currentProfile().avatar || "kenji";
  ui.profilesModal.classList.add("show");
}
function saveOrCreateProfile(){
  const name = (ui.profileName.value||"").trim() || "Spieler";
  const avatar = ui.avatarGrid.dataset.selected || "kenji";
  const cur = currentProfile();
  if(cur){
    cur.name = name; cur.avatar = avatar; if(!cur.settings) cur.settings = {speech:false,level:3};
  }else{
    const id = "p"+(Math.random().toString(36).slice(2,7));
    profiles.items.push({id, name, avatar, settings:{speech:false,level:3}, stats:defaultStats()});
    profiles.currentId = id;
  }
  saveProfiles(); populateProfileSelect(); ui.profilesModal.classList.remove("show");
}
function currentProfile(){ return profiles.items.find(p=>p.id===profiles.currentId) || profiles.items[0]; }
function hydrateStateFromProfile(){
  const p = currentProfile(); const s = (p && p.stats) ? p.stats : defaultStats();
  return {
    xp: s.xp||0, correct:s.correct||0, total:s.total||0, streak:s.streak||0, bestStreak:s.bestStreak||0,
    mode: "adaptive", level: (p.settings && p.settings.level) ? p.settings.level : 3,
    ops:{add:true,sub:true,mul:true,div:true}, times: s.times||[]
  };
}
function applySettingsToUI(){
  const p = currentProfile(); ui.speechToggle.checked = !!(p.settings && p.settings.speech);
  ui.level.value = state.level; ui.levelLabel.textContent = state.level;
  for(const k of Object.keys(opsEls)) opsEls[k].checked = !!state.ops[k];
}
function persist(){
  const p = currentProfile();
  p.stats = { xp:state.xp, correct:state.correct, total:state.total, streak:state.streak, bestStreak:state.bestStreak, times:state.times, history:(p.stats.history||[]), prestige:(p.stats.prestige||0) };
  p.settings = p.settings || {}; p.settings.level = state.level; p.settings.speech = !!ui.speechToggle.checked;
  saveProfiles();
}
function saveProfiles(){ localStorage.setItem("lom:profiles:v1", JSON.stringify(profiles)); }
function loadProfiles(){ try{ const raw = localStorage.getItem("lom:profiles:v1"); return raw? JSON.parse(raw) : {currentId:null, items:[]}; }catch(e){ return {currentId:null, items:[]}; } }

/* ================== Statistik ================== */
function openStats(){
  const p = currentProfile(); const s = p.stats || defaultStats();
  const total = s.total||0, correct = s.correct||0, acc = total? Math.round(correct/total*100): 0;
  const avg = s.times && s.times.length ? (s.times.reduce((a,b)=>a+b,0)/s.times.length) : 0;
  ui.stTotal.textContent = total; ui.stAcc.textContent = acc + "%"; ui.stAvg.textContent = avg.toFixed(1) + "s";
  ui.stBest.textContent = s.bestStreak||0; ui.stStreak.textContent = s.streak||0; ui.stXP.textContent = s.xp||0;

  const hist = (s.history||[]).slice(-30);
  drawSpark(hist, ui.chartSpark);

  ui.statsHint.textContent = hist.length ? "Sparkline zeigt die letzten 30 Aufgaben (1 = richtig, 0 = falsch; H√∂he = Geschwindigkeit)." : "Noch keine Verlaufsdaten ‚Äì l√∂se ein paar Aufgaben!";
  ui.statsModal.classList.add("show");
}

function drawSpark(hist, canvas){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);
  // Achsen zart
  ctx.strokeStyle = "#1b244f"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(30, h-20); ctx.lineTo(w-10, h-20); ctx.stroke();

  // Skalen
  const left=30, right=w-10, top=10, bottom=h-20;
  const n = Math.max(1, hist.length);
  const maxS = Math.max(2, ...(hist.map(x=>x.s||0)), 3);

  // Linie: Geschwindigkeit invertiert (schneller = h√∂her)
  ctx.strokeStyle = "#60a5fa"; ctx.lineWidth=2; ctx.beginPath();
  hist.forEach((e,i)=>{
    const x = left + (i/(n-1||1))*(right-left);
    const y = top + (1 - Math.min(1,( (3/(e.s||3)) ))) * (bottom-top); // 3s gut => hoch
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Punkte: Treffer/Falsch
  hist.forEach((e,i)=>{
    const x = left + (i/(n-1||1))*(right-left);
    const y = top + (1 - Math.min(1,(3/(e.s||3)))) * (bottom-top);
    ctx.fillStyle = e.ok? "#22c55e" : "#ef4444";
    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
  });
}

function exportCSV(){
  const p = currentProfile(); const hist = (p.stats.history||[]);
  const rows = [["timestamp","iso","correct","seconds"]];
  hist.forEach(e=>{
    const d = new Date(e.t);
    rows.push([e.t, d.toISOString(), e.ok?1:0, e.s]);
  });
  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "LegendsOfMath-Statistik.csv";
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 500);
}

/* ================== Leaderboard ================== */
async function openLeaderboard(){
  try{
    const gid = (window.firebaseApi?.groupId || "CLASS-3A");
    ui.lbGroup.textContent = gid;
    ui.lbBody.innerHTML = `<tr><td colspan="7" style="opacity:.8">Lade‚Ä¶</td></tr>`;
    const rows = await window.firebaseApi?.fetchLeaderboard(gid, 50) || [];
    if(!rows.length){
      ui.lbBody.innerHTML = `<tr><td colspan="7" style="opacity:.8">Noch keine Eintr√§ge.</td></tr>`;
    }else{
      ui.lbBody.innerHTML = rows.map((r,i)=>(
        `<tr>
          <td>${i+1}</td>
          <td>${escapeHtml(r.profileName||"Spieler")}</td>
          <td>${r.xp||0}</td>
          <td>${r.prestige||0}</td>
          <td>${r.accuracy||0}%</td>
          <td>${r.bestStreak||0}</td>
          <td>${r.ts?.toDate ? r.ts.toDate().toLocaleString() : "‚Äì"}</td>
        </tr>`
      )).join("");
    }
    ui.leaderboardModal.classList.add("show");
  }catch(e){
    console.warn("LB load failed", e);
    ui.lbBody.innerHTML = `<tr><td colspan="7" style="opacity:.8">Fehler beim Laden (offline?).</td></tr>`;
    ui.leaderboardModal.classList.add("show");
  }
}

/* ================== Utils ================== */
function feedbackCorrect(html){ ui.feedback.innerHTML = `<span class="correct">${html}</span>`; }
function feedbackWrong(html){ ui.feedback.innerHTML = `<span class="wrong">${html}</span>`; }
function feedbackNeutral(html){ ui.feedback.innerHTML = `<span class="neutral">${html}</span>`; }
function r(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function showToast(text){ ui.toast.innerHTML = text; ui.toast.classList.remove("show"); void ui.toast.offsetWidth; ui.toast.classList.add("show"); setTimeout(()=> ui.toast.classList.remove("show"), 2600); }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

function updateBlockBar(){
  ui.blockFill.style.width = block.active ? (Math.min(1, block.index/Math.max(1, block.size))*100).toFixed(1)+"%" : "0%";
}

/* ================== Reset ================== */
function resetProgress(){
  if(confirm("Fortschritt dieses Profils wirklich l√∂schen? (XP, Genauigkeit, Serien, Zeiten, Verlauf)")){
    const p = currentProfile(); p.stats = defaultStats(); saveProfiles();
    state = hydrateStateFromProfile(); updateHUD(); newQuestion(true);
  }
}
</script>
<!-- PWA / Service Worker Registrierung -->
<script>
(function(){
  if (!('serviceWorker' in navigator)) return;
  // kleine Delay, damit die Seite first-painten kann
  const register = () => navigator.serviceWorker
    .register('./service-worker.js')
    .then(r => console.info('[PWA] Service Worker registriert:', r.scope))
    .catch(err => console.warn('[PWA] Registrierung fehlgeschlagen:', err));

  if (document.readyState === 'complete') register();
  else window.addEventListener('load', register);
})();
</script>

</body>
</html>





